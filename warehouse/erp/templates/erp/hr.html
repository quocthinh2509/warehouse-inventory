{% load static %}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>HR — ERP Test</title>
  <link rel="stylesheet" href="{% static 'erp/styles.css' %}" />
</head>
<body>
  <main class="container">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h1>HR</h1>
      <form id="baseurl-form" class="row" style="gap:8px; min-width:360px">
        <input name="base_url" placeholder="http://127.0.0.1:8000/erp/api" />
        <button class="primary" type="submit">Save base_url</button>
      </form>
    </div>

    <div class="grid grid-2">
      <section class="card">
        <h2>Department</h2>
        <form id="f-dept">
          <label>Mã</label><input name="code" required />
          <label>Tên</label><input name="name" required />
          <button class="primary">Create</button>
        </form>
        <pre id="dept-list" class="small"></pre>
      </section>

      <section class="card">
        <h2>Worksite</h2>
        <form id="f-site">
          <label>Mã</label><input name="code" required />
          <label>Tên</label><input name="name" required />
          <div class="row">
            <div style="flex:1"><label>Lat</label><input name="latitude" /></div>
            <div style="flex:1"><label>Lng</label><input name="longitude" /></div>
          </div>
          <label>Radius (m)</label><input name="radius_m" value="200" />
          <button class="primary">Create</button>
        </form>
        <pre id="site-list" class="small"></pre>
      </section>

      <section class="card">
        <h2>Shift</h2>
        <form id="f-shift">
          <label>Mã</label><input name="code" required />
          <label>Tên</label><input name="name" required />
          <div class="row">
            <div style="flex:1"><label>Start</label><input name="start_time" value="08:30:00" /></div>
            <div style="flex:1"><label>End</label><input name="end_time" value="17:30:00" /></div>
          </div>
          <label>Break (minutes)</label><input name="break_minutes" value="60" />
          <button class="primary">Create</button>
        </form>
        <pre id="shift-list" class="small"></pre>
      </section>

      <section class="card">
        <h2>Employee</h2>
        <form id="f-emp">
          <label>Mã NV</label><input name="code" required />
          <label>Họ tên</label><input name="full_name" required />
          <div class="row">
            <div style="flex:1"><label>Email</label><input name="email" /></div>
            <div style="flex:1"><label>Phone</label><input name="phone" /></div>
          </div>
          <label>Department ID</label><input name="department" placeholder="1" />
          <label>Lương cơ bản</label><input name="base_salary" value="10000000.00" />
          <div class="row">
            <div style="flex:1"><label>Default Shift ID</label><input name="default_shift" placeholder="1" /></div>
            <div style="flex:1"><label>Default Worksite ID</label><input name="default_worksite" placeholder="1" /></div>
          </div>
          <label>Active</label>
          <select name="is_active"><option value="true" selected>true</option><option>false</option></select>
          <button class="primary">Create</button>
        </form>
        <pre id="emp-list" class="small"></pre>
      </section>
    </div>
  </main>
  <div class="toast"></div>
  <script type="module">
    import { fetchJSON, setFormHandlers, formToJSON, setBaseUrlForm } from "{% static 'erp/app.js' %}";
    setBaseUrlForm('#baseurl-form');

    (async ()=>{
      const depts = await fetchJSON('/departments/');
      document.querySelector('#dept-list').textContent = JSON.stringify(depts, null, 2);
      const sites = await fetchJSON('/worksites/');
      document.querySelector('#site-list').textContent = JSON.stringify(sites, null, 2);
      const shifts = await fetchJSON('/shifts/');
      document.querySelector('#shift-list').textContent = JSON.stringify(shifts, null, 2);
      const emps = await fetchJSON('/employees/');
      document.querySelector('#emp-list').textContent = JSON.stringify(emps, null, 2);
    })();

    setFormHandlers('#f-dept', async fd=>{
      await fetchJSON('/departments/', { method:'POST', body: JSON.stringify(formToJSON(fd)) });
      location.reload();
    });
    setFormHandlers('#f-site', async fd=>{
      await fetchJSON('/worksites/', { method:'POST', body: JSON.stringify(formToJSON(fd)) });
      location.reload();
    });
    setFormHandlers('#f-shift', async fd=>{
      await fetchJSON('/shifts/', { method:'POST', body: JSON.stringify(formToJSON(fd)) });
      location.reload();
    });
    setFormHandlers('#f-emp', async fd=>{
      const data = formToJSON(fd); data.is_active = data.is_active === 'true';
      await fetchJSON('/employees/', { method:'POST', body: JSON.stringify(data) });
      location.reload();
    });
  </script>
</body>
</html>
