{% load static %}
<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Payroll â€” ERP Test</title>
  <link rel="stylesheet" href="{% static 'erp/styles.css' %}" />
</head>
<body>
  <main class="container">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h1>Payroll</h1>
      <form id="baseurl-form" class="row" style="gap:8px; min-width:360px">
        <input name="base_url" placeholder="http://127.0.0.1:8000/erp/api" />
        <button class="primary" type="submit">Save base_url</button>
      </form>
    </div>

    <div class="grid grid-2">
      <section class="card">
        <h2>Create Period</h2>
        <form id="f-period">
          <label>Code</label><input name="code" value="2025-09" />
          <div class="row">
            <div style="flex:1"><label>Start</label><input name="start_date" value="2025-09-01" /></div>
            <div style="flex:1"><label>End</label><input name="end_date" value="2025-09-30" /></div>
          </div>
          <button class="primary">Create</button>
        </form>
        <pre id="period-list" class="small"></pre>
      </section>

      <section class="card">
        <h2>Preview</h2>
        <form id="f-preview" class="row" style="gap:8px">
          <input name="period_id" value="1" style="max-width:160px" />
          <button class="primary">Run Preview</button>
        </form>
        <pre id="preview" class="small"></pre>
      </section>

      <section class="card">
        <h2>Create Payroll Line (manual)</h2>
        <form id="f-line">
          <div class="row">
            <div style="flex:1"><label>Period</label><input name="period" value="1" /></div>
            <div style="flex:1"><label>Employee</label><input name="employee" value="1" /></div>
          </div>
          <label>Base Salary</label><input name="base_salary" value="10000000.00" />
          <div class="grid grid-3">
            <div><label>Days Worked</label><input name="days_worked" value="10" /></div>
            <div><label>OT Hours</label><input name="overtime_hours" value="0" /></div>
            <div><label>Leave Hours</label><input name="leave_hours" value="0" /></div>
          </div>
          <div class="grid grid-3">
            <div><label>Deductions</label><input name="deductions" value="0" /></div>
            <div><label>Bonuses</label><input name="bonuses" value="0" /></div>
            <div><label>Net Pay</label><input name="net_pay" value="384615.38" /></div>
          </div>
          <button class="primary">Create</button>
        </form>
        <pre id="lines" class="small"></pre>
      </section>
    </div>
  </main>
  <div class="toast"></div>
  <script type="module">
    import { fetchJSON, setFormHandlers, formToJSON, setBaseUrlForm } from "{% static 'erp/app.js' %}";
    setBaseUrlForm('#baseurl-form');

    async function reload(){
      const p = await fetchJSON('/payroll/periods/');
      document.querySelector('#period-list').textContent = JSON.stringify(p, null, 2);
      const l = await fetchJSON('/payroll/lines/');
      document.querySelector('#lines').textContent = JSON.stringify(l, null, 2);
    }
    setFormHandlers('#f-period', async fd=>{
      await fetchJSON('/payroll/periods/', { method:'POST', body: JSON.stringify(formToJSON(fd)) });
      reload();
    });
    setFormHandlers('#f-preview', async fd=>{
      const res = await fetchJSON('/payroll/preview', { method:'POST', body: JSON.stringify(formToJSON(fd)) });
      document.querySelector('#preview').textContent = JSON.stringify(res, null, 2);
    });
    setFormHandlers('#f-line', async fd=>{
      await fetchJSON('/payroll/lines/', { method:'POST', body: JSON.stringify(formToJSON(fd)) });
      reload();
    });
    reload();
  </script>
</body>
</html>
