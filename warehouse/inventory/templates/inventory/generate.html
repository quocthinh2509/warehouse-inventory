{% extends "inventory/base.html" %}
{% block title %}Generate Labels{% endblock %}

{% block extra_head %}
<style>
  .gen-wrap{max-width:1100px;margin:0 auto}
  .gen-h2{font-size:28px;font-weight:700;margin:6px 0 16px}
  .gen-card{background:#0b1220;border:1px solid #263247;border-radius:12px}
  .gen-body{padding:16px}
  .gen-grid{display:grid;grid-template-columns:1fr 1fr 160px 160px;gap:12px}
  .gen-field{display:flex;flex-direction:column;gap:6px}
  .gen-label{font-size:14px;opacity:.9}
  input.gen-input, select.gen-select{padding:10px;border-radius:8px;border:1px solid #2a3a50;background:#0e1625;color:#e6edf3}
  #id_qty, #id_import_date{padding:10px;border-radius:8px;border:1px solid #2a3a50;background:#0e1625;color:#e6edf3;width:100%}
  .gen-actions{display:flex;gap:12px;align-items:center;margin-top:14px;flex-wrap:wrap}
  .btn-primary{padding:12px 18px;border-radius:10px;border:0;background:#0ea5b8;color:#001018;font-weight:700;cursor:pointer}
  .btn-primary:hover{filter:brightness(1.1)}
  .btn-ghost{padding:10px 14px;border-radius:10px;border:1px solid #2a3a50;background:#0e1625;color:#e6edf3;cursor:pointer}
  .gen-note{font-size:14px;opacity:.8}
  table.log{width:100%;border-collapse:collapse}
  table.log th, table.log td{padding:8px;border-bottom:1px dashed #263247}
  table.log th{text-align:left}
  table.log td.num{text-align:right}

  /* Toast nh·ªè ·ªü g√≥c d∆∞·ªõi ph·∫£i */
  .toast{position:fixed;right:16px;bottom:16px;background:#0ea5b8;color:#001018;
         padding:10px 14px;border-radius:10px;font-weight:700;box-shadow:0 4px 16px rgba(0,0,0,.35);
         opacity:0;transform:translateY(8px);transition:all .25s;z-index:9999}
  .toast.show{opacity:1;transform:translateY(0)}
</style>
{% endblock %}

{% block content %}
<div class="gen-wrap">
  <h2 class="gen-h2">üßæ Generate Labels</h2>

  {{ products|json_script:"js-products" }}

  <!-- B·ªé panel last_batch -->

  <form method="post" id="form-generate" autocomplete="off" class="gen-card">
    {% csrf_token %}
    <div class="gen-body">
      <div class="gen-grid">
        <div class="gen-field">
          <label class="gen-label" for="f-sku">SKU</label>
          <input id="f-sku" name="sku" class="gen-input" list="dl-sku" required>
          <datalist id="dl-sku">
            {% for p in products %}<option value="{{ p.sku }}">{{ p.name }}</option>{% endfor %}
          </datalist>
        </div>
        <div class="gen-field">
          <label class="gen-label" for="f-name">T√™n s·∫£n ph·∫©m</label>
          <input id="f-name" name="name" class="gen-input" list="dl-name" required>
          <datalist id="dl-name">
            {% for p in products %}<option value="{{ p.name }}">{{ p.sku }}</option>{% endfor %}
          </datalist>
        </div>
        <div class="gen-field">
          <label class="gen-label" for="id_import_date">Ng√†y nh·∫≠p (dd/mm/yyyy)</label>
          {{ form.import_date|safe }}
        </div>
        <div class="gen-field">
          <label class="gen-label" for="id_qty">S·ªë l∆∞·ª£ng</label>
          {{ form.qty|safe }}
        </div>
      </div>

      <div class="gen-actions">
        <button type="submit" class="btn-primary">Th√™m v√†o gi·ªè in</button>
        <span class="gen-note">Khi b·∫•m ‚ÄúT·∫°o & t·∫£i ZIP‚Äù, h·ªá th·ªëng s·∫Ω gen t·∫•t c·∫£ tem trong gi·ªè th√†nh 1 batch.</span>
      </div>
    </div>
  </form>

  <div class="gen-card" style="margin-top:14px">
    <div class="gen-body">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <h3 style="margin:0;font-size:18px">üß∫ Gi·ªè in hi·ªán t·∫°i</h3>
        <div style="display:flex;gap:8px">
          <a href="{% url 'clear_queue' %}" class="btn-ghost">üßπ X√≥a gi·ªè</a>
          {% if queue %}
            <!-- G·ª≠i POST t·ªõi finalize_queue v√†o iframe ·∫©n ƒë·ªÉ t·∫£i ngay -->
            <form action="{% url 'finalize_queue' %}" method="post" target="dlframe" style="display:inline">
              {% csrf_token %}
              <button type="submit" class="btn-primary" id="btn-finalize">üßæ T·∫°o & t·∫£i ZIP</button>
            </form>
          {% else %}
            <button class="btn-primary" disabled>üßæ T·∫°o & t·∫£i ZIP</button>
          {% endif %}
        </div>
      </div>

      {% if queue %}
        <div style="overflow:auto;margin-top:10px">
          <table class="log">
            <thead>
              <tr>
                <th>#</th>
                <th>SKU</th>
                <th>T√™n s·∫£n ph·∫©m</th>
                <th>Ng√†y nh·∫≠p</th>
                <th class="num">S·ªë l∆∞·ª£ng</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              {% for row in queue %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ row.sku }}</td>
                <td>{{ row.name }}</td>
                <td>{{ row.import_date }}</td>
                <td class="num">{{ row.qty }}</td>
                <td><a class="btn-ghost" href="{% url 'remove_queue_line' forloop.counter0 %}">X√≥a</a></td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <td colspan="4" style="text-align:right;opacity:.9">T·ªïng tem</td>
                <td class="num" style="font-weight:700">{{ total_qty }}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      {% else %}
        <p class="gen-note" style="margin-top:10px">Ch∆∞a c√≥ g√¨ trong gi·ªè. H√£y th√™m SKU ·ªü form b√™n tr√™n.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- iframe ·∫©n ƒë·ªÉ nh·∫≠n response ZIP (download ngay) -->
<iframe name="dlframe" id="dlframe" style="display:none"></iframe>

<script>
/* Auto-fill SKU ‚Üî Name theo list products ƒë√£ nh√∫ng */
(function(){
  const DATA = JSON.parse(document.getElementById('js-products').textContent || '[]');
  const bySku  = new Map();  // sku -> name
  const byName = new Map();  // name -> sku
  for (const p of DATA) { bySku.set(p.sku, p.name); byName.set(p.name, p.sku); }

  const skuEl  = document.getElementById('f-sku');
  const nameEl = document.getElementById('f-name');

  const fillBySku  = () => { const v = skuEl.value.trim();  if (bySku.has(v))  nameEl.value = bySku.get(v); };
  const fillByName = () => { const v = nameEl.value.trim(); if (byName.has(v)) skuEl.value = byName.get(v); };

  ['input','change','blur'].forEach(e => skuEl.addEventListener(e,  fillBySku));
  ['input','change','blur'].forEach(e => nameEl.addEventListener(e, fillByName));
})();
</script>

<script>
/* Auto-fill "Ng√†y nh·∫≠p" = h√¥m nay n·∫øu √¥ ƒëang tr·ªëng.
   H·ªó tr·ª£ c·∫£ input type="date" (yyyy-mm-dd) v√† text (dd/mm/yyyy) */
(function () {
  const el = document.getElementById('id_import_date');
  if (!el) return;

  const now = new Date();
  const pad = n => String(n).padStart(2, '0');
  const yyyy = now.getFullYear();
  const mm = pad(now.getMonth() + 1);
  const dd = pad(now.getDate());

  if (el.type === 'date') {
    const val = `${yyyy}-${mm}-${dd}`;
    if (!el.value) el.value = val;
    el.max = val; // kho√° ch·ªçn ng√†y t∆∞∆°ng lai
  } else {
    const val = `${dd}/${mm}/${yyyy}`;
    if (!el.value) el.value = val;
    if (!el.placeholder) el.placeholder = 'dd/mm/yyyy';
    el.setAttribute('inputmode', 'numeric');
  }
})();
</script>

<script>
/* Toast khi b·∫•m "T·∫°o & t·∫£i ZIP" */
(function(){
  const btn = document.getElementById('btn-finalize');
  if (!btn) return;

  function toast(msg, dur=2200){
    let t = document.getElementById('dl-toast');
    if (!t) {
      t = document.createElement('div');
      t.id = 'dl-toast';
      t.className = 'toast';
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(t._tm);
    t._tm = setTimeout(()=>t.classList.remove('show'), dur);
  }

  btn.addEventListener('click', function(){
    toast('ƒêang t·∫°o & t·∫£i ZIP...');
    setTimeout(()=>toast('ƒê√£ t·∫°o barcode cho ƒë·ª£t in!'), 1200);
  });
})();
</script>
{% endblock %}
