{% extends "inventory/base.html" %}
{% block title %}Generate Labels{% endblock %}

{% block extra_head %}
<style>
  .gen-wrap {
    max-width: 1200px;
    margin: 0 auto;
    padding: 24px;
  }
  .gen-h2 {
    font-size: 28px;
    font-weight: 700;
    margin: 0 0 24px;
  }
  .gen-card {
    margin-bottom: 16px;
  }
  .gen-body {
    padding: 20px;
  }
  .gen-grid {
    display: grid;
    grid-template-columns: 1fr 1fr 180px 180px;
    gap: 16px;
  }
  .gen-field {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .gen-label {
    font-size: 14px;
    color: var(--muted);
  }
  .gen-actions {
    display: flex;
    gap: 12px;
    align-items: center;
    margin-top: 16px;
    flex-wrap: wrap;
  }
  /* Base button style */
  .btn {
    padding: 10px 16px; /* Uniform padding */
    border-radius: 8px;
    border: none; /* Remove border for consistency */
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s ease, transform 0.2s ease;
    width: 160px; /* Fixed width for uniformity */
    text-align: center;
  }
  .btn-primary {
    background: var(--primary);
    color: #FFFFFF;
  }
  .btn-primary:hover {
    background: #2563EB;
    transform: translateY(-2px);
  }
  .btn-primary:disabled {
    background: #93C5FD;
    cursor: not-allowed;
  }
  .btn-ghost {
    background: #FFFFFF;
    color: var(--text);
  }
  .btn-ghost:hover {
    background: #F3F4F6;
    transform: translateY(-2px);
  }
  .gen-note {
    font-size: 14px;
    color: var(--muted);
  }
  table.log {
    width: 100%;
    border-collapse: collapse;
  }
  table.log th, table.log td {
    padding: 12px;
    border-bottom: 1px solid var(--border);
  }
  table.log th {
    text-align: left;
    font-weight: 600;
  }
  table.log td.num {
    text-align: right;
  }
  .toast {
    position: fixed;
    right: 16px;
    bottom: 16px;
    background: #DBEAFE; /* Light blue background for white theme */
    color: #1F2937; /* Dark text for high contrast */
    border: 1px solid #BFDBFE; /* Subtle border */
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: 600;
    box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
    opacity: 0;
    transform: translateY(12px);
    transition: all 0.3s ease;
    z-index: 9999;
  }
  .toast.show {
    opacity: 1;
    transform: translateY(0);
  }
</style>
{% endblock %}

{% block content %}
<div class="gen-wrap">
  <h2 class="gen-h2">üßæ Generate Labels</h2>

  {{ products|json_script:"js-products" }}

  <!-- B·ªé panel last_batch -->

  <form method="post" id="form-generate" autocomplete="off" class="gen-card">
    {% csrf_token %}
    <div class="gen-body">
      <div class="gen-grid">
        <div class="gen-field">
          <label class="gen-label" for="f-sku">SKU</label>
          <input id="f-sku" name="sku" class="gen-input" list="dl-sku" required>
          <datalist id="dl-sku">
            {% for p in products %}<option value="{{ p.sku }}">{{ p.name }}</option>{% endfor %}
          </datalist>
        </div>
        <div class="gen-field">
          <label class="gen-label" for="f-name">T√™n s·∫£n ph·∫©m</label>
          <input id="f-name" name="name" class="gen-input" list="dl-name" required>
          <datalist id="dl-name">
            {% for p in products %}<option value="{{ p.name }}">{{ p.sku }}</option>{% endfor %}
          </datalist>
        </div>
        <div class="gen-field">
          <label class="gen-label" for="id_import_date">Ng√†y nh·∫≠p (dd/mm/yyyy)</label>
          {{ form.import_date|safe }}
        </div>
        <div class="gen-field">
          <label class="gen-label" for="id_qty">S·ªë l∆∞·ª£ng</label>
          {{ form.qty|safe }}
        </div>
      </div>

      <div class="gen-actions">
        <button type="submit" class="btn btn-primary">Th√™m v√†o gi·ªè in</button>
        <span class="gen-note">Khi b·∫•m ‚ÄúT·∫°o & t·∫£i ZIP‚Äù, h·ªá th·ªëng s·∫Ω gen t·∫•t c·∫£ tem trong gi·ªè th√†nh 1 batch.</span>
      </div>
    </div>
  </form>

  <div class="gen-card" style="margin-top:14px">
    <div class="gen-body">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap">
        <h3 style="margin:0;font-size:20px">üß∫ Gi·ªè in hi·ªán t·∫°i</h3>
        <div style="display:flex;gap:10px;flex-wrap:wrap">
          <a href="{% url 'clear_queue' %}" class="btn btn-primary" style="text-decoration: none; outline: none; border: none;">üßπ X√≥a h·∫øt</a>
          {% if queue %}
            <!-- G·ª≠i POST t·ªõi finalize_queue v√†o iframe ·∫©n ƒë·ªÉ t·∫£i ngay -->
            <form action="{% url 'finalize_queue' %}" method="post" target="dlframe" style="display:inline">
              {% csrf_token %}
              <button type="submit" class="btn btn-primary" id="btn-finalize">üßæ T·∫°o & t·∫£i ZIP</button>
            </form>
          {% else %}
            <button class="btn btn-primary" disabled>üßæ T·∫°o & t·∫£i ZIP</button>
          {% endif %}
        </div>
      </div>

      {% if queue %}
        <div style="overflow:auto;margin-top:10px">
          <table class="log">
            <thead>
              <tr>
                <th>#</th>
                <th>SKU</th>
                <th>T√™n s·∫£n ph·∫©m</th>
                <th>Ng√†y nh·∫≠p</th>
                <th class="num">S·ªë l∆∞·ª£ng</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
              {% for row in queue %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ row.sku }}</td>
                <td>{{ row.name }}</td>
                <td>{{ row.import_date }}</td>
                <td class="num">{{ row.qty }}</td>
                <td><a class="btn-ghost" href="{% url 'remove_queue_line' forloop.counter0 %}">X√≥a</a></td>
              </tr>
              {% endfor %}
            </tbody>
            <tfoot>
              <tr>
                <td colspan="4" style="text-align:right;opacity:.9">T·ªïng tem</td>
                <td class="num" style="font-weight:700">{{ total_qty }}</td>
                <td></td>
              </tr>
            </tfoot>
          </table>
        </div>
      {% else %}
        <p class="gen-note" style="margin-top:10px">Ch∆∞a c√≥ g√¨ trong gi·ªè. H√£y th√™m SKU ·ªü form b√™n tr√™n.</p>
      {% endif %}
    </div>
  </div>
</div>

<!-- iframe ·∫©n ƒë·ªÉ nh·∫≠n response ZIP (download ngay) -->
<iframe name="dlframe" id="dlframe" style="display:none"></iframe>

<script>
/* Auto-fill SKU ‚Üî Name theo list products ƒë√£ nh√∫ng */
(function(){
  const DATA = JSON.parse(document.getElementById('js-products').textContent || '[]');
  const bySku  = new Map();  // sku -> name
  const byName = new Map();  // name -> sku
  for (const p of DATA) { bySku.set(p.sku, p.name); byName.set(p.name, p.sku); }

  const skuEl  = document.getElementById('f-sku');
  const nameEl = document.getElementById('f-name');

  const fillBySku  = () => { const v = skuEl.value.trim();  if (bySku.has(v))  nameEl.value = bySku.get(v); };
  const fillByName = () => { const v = nameEl.value.trim(); if (byName.has(v)) skuEl.value = byName.get(v); };

  ['input','change','blur'].forEach(e => skuEl.addEventListener(e,  fillBySku));
  ['input','change','blur'].forEach(e => nameEl.addEventListener(e, fillByName));
})();
</script>

<script>
/* Auto-fill "Ng√†y nh·∫≠p" = h√¥m nay n·∫øu √¥ ƒëang tr·ªëng.
   H·ªó tr·ª£ c·∫£ input type="date" (yyyy-mm-dd) v√† text (dd/mm/yyyy) */
(function () {
  const el = document.getElementById('id_import_date');
  if (!el) return;

  const now = new Date();
  const pad = n => String(n).padStart(2, '0');
  const yyyy = now.getFullYear();
  const mm = pad(now.getMonth() + 1);
  const dd = pad(now.getDate());

  if (el.type === 'date') {
    const val = `${yyyy}-${mm}-${dd}`;
    if (!el.value) el.value = val;
    el.max = val; // kho√° ch·ªçn ng√†y t∆∞∆°ng lai
  } else {
    const val = `${dd}/${mm}/${yyyy}`;
    if (!el.value) el.value = val;
    if (!el.placeholder) el.placeholder = 'dd/mm/yyyy';
    el.setAttribute('inputmode', 'numeric');
  }
})();
</script>

<script>
/* Toast khi b·∫•m "T·∫°o & t·∫£i ZIP" */
(function(){
  const btn = document.getElementById('btn-finalize');
  if (!btn) return;

  function toast(msg, dur=2200){
    let t = document.getElementById('dl-toast');
    if (!t) {
      t = document.createElement('div');
      t.id = 'dl-toast';
      t.className = 'toast';
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.classList.add('show');
    clearTimeout(t._tm);
    t._tm = setTimeout(()=>t.classList.remove('show'), dur);
  }

  btn.addEventListener('click', function(){
    toast('ƒêang t·∫°o & t·∫£i ZIP...');
    setTimeout(()=>toast('ƒê√£ t·∫°o barcode cho ƒë·ª£t in!'), 1200);
  });
})();
</script>
{% endblock %}