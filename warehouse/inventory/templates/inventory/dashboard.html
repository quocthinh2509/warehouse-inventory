{% extends "inventory/base.html" %}
{% block title %}Dashboard{% endblock %}

{% block extra_head %}
<style>
  /* To√†n trang */
  main.container{max-width:95%}
  .dash-page{width:100%}

  /* Hero */
  .dash-hero{
    background:linear-gradient(135deg,#0ea5e9aa,#0284c780);
    border-radius:16px;padding:24px 28px;margin-bottom:20px;
    display:flex;align-items:center;gap:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)
  }
  .dash-hero h2{margin:0;font-size:34px;display:flex;gap:10px;align-items:center;color:#fff}
  .dash-hero .hint{color:#dbeafe;font-size:15px;margin-left:auto}

  /* Cards */
  .dash-cards{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
    gap:16px;margin-bottom:20px
  }
  .dash-card{
    background:var(--card-bg);border:1px solid var(--border);
    border-radius:14px;padding:20px;text-align:center;transition:transform .2s ease;
    box-shadow:0 4px 14px rgba(0,0,0,.18)
  }
  .dash-card:hover{transform:translateY(-3px)}
  .dash-card header{color:var(--muted);font-weight:600;font-size:15px}
  .dash-card h3{margin:.4rem 0 0;font-size:36px;color:#0ea5e9}

  /* B·ªô l·ªçc */
  .dash-panel{
    background:var(--card-bg);border:1px solid var(--border);
    border-radius:14px;padding:18px;margin-bottom:18px;box-shadow:0 3px 10px rgba(0,0,0,.15)
  }
  .filters{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
    gap:12px;align-items:end
  }
  .filters label{font-size:14px;color:var(--muted);margin-bottom:4px;display:block}
  .dash-panel input,.dash-panel select{height:42px;font-size:15px;padding:0 8px}
  .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-top:12px}
  .pill{padding:4px 10px;border-radius:999px;background:#0b1220;border:1px solid #263247;font-size:13px}

  /* Range picker (gi·ªëng ·∫£nh) */
  .range-wrap{position:relative}
  .range-input{
    height:42px;padding:0 12px;border:1px solid var(--border);
    background:var(--card-bg);border-radius:10px;width:100%
  }
  .preset-menu{
    position:absolute;left:0;top:48px;z-index:5;background:#0f172a;border:1px solid #263247;border-radius:12px;
    width:260px;padding:8px;box-shadow:0 10px 30px rgba(0,0,0,.35);display:none
  }
  .preset-menu button{
    width:100%;text-align:left;border:none;background:transparent;padding:10px 12px;border-radius:8px;
    color:#cbd5e1;cursor:pointer
  }
  .preset-menu button:hover{background:#132035}
  .range-wrap.open .preset-menu{display:block}
  @media(max-width:1000px){.preset-menu{width:210px}}

  /* B·∫£ng */
  .table-card{background:var(--card-bg);border:1px solid var(--border);border-radius:14px}
  .table-wrap{overflow:auto;max-height:70vh;border-radius:14px}
  table{width:100%;min-width:1200px;border-collapse:collapse}
  thead th{position:sticky;top:0;background:#1e293b;z-index:1;padding:12px;text-align:left;font-size:18px;border-bottom:1px solid #334155}
  tbody td{padding:10px 12px;font-size:18px;border-bottom:1px solid #263247}
  tbody tr:nth-child(odd){background:rgba(255,255,255,.02)}
  th.sortable a{display:inline-flex;gap:6px;align-items:center;text-decoration:none;color:inherit}
  .dir-badge{font-size:12px}
</style>

<!-- Litepicker (date range) -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css">
<script defer src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>
{% endblock %}

{% block content %}
<div class="dash-page">
  <!-- Hero -->
  <div class="dash-hero">
    <h2>üìä Dashboard</h2>
  </div>

  <!-- Cards -->
  <div class="dash-cards">
    <article class="dash-card">
      <header>T·ªïng IN (theo b·ªô l·ªçc)</header>
      <h3>{{ total_in }}</h3>
    </article>
    <article class="dash-card">
      <header>T·ªïng OUT (theo b·ªô l·ªçc)</header>
      <h3>{{ total_out }}</h3>
    </article>
  </div>

  <!-- Filters -->
  <form id="filterForm" method="get" class="dash-panel">
    <div class="filters">
      <!-- Date range like screenshot -->
      <div class="range-wrap" id="rangeWrap">
        <label>Th·ªùi gian</label>
        <input id="rangeDisplay" class="range-input" type="text" placeholder="Start date ‚Üí End date" readonly>
        <input type="hidden" name="start" id="startInput" value="{{ start }}">
        <input type="hidden" name="end"   id="endInput"   value="{{ end }}">
        <div class="preset-menu" id="presetMenu">
          <button data-preset="today">Today</button>
          <button data-preset="yesterday">Yesterday</button>
          <button data-preset="this_week">This Week</button>
          <button data-preset="last_7">Last 7 Days</button>
          <button data-preset="this_month">This Month</button>
          <button data-preset="last_month">Last Month</button>
        </div>
      </div>

      <div>
        <label>Action</label>
        <select name="action">
          <option value="">(T·∫•t c·∫£)</option>
          <option value="IN"  {% if action == "IN" %}selected{% endif %}>IN</option>
          <option value="OUT" {% if action == "OUT" %}selected{% endif %}>OUT</option>
        </select>
      </div>

      <div>
        <label>Kho</label>
        <select name="wh">
          <option value="">(T·∫•t c·∫£)</option>
          {% for w in warehouses %}
            <option value="{{ w.id }}" {% if wh_id == w.id|stringformat:"s" %}selected{% endif %}>{{ w.code }}</option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label>T√¨m ki·∫øm</label>
        <input type="search" name="q" value="{{ q }}" placeholder="barcode / SKU / t√™n / note">
      </div>

      <div>
        <label>Hi·ªÉn th·ªã</label>
        <select name="per">
          {% for n in per_options %}
            <option value="{{ n }}" {% if per == n %}selected{% endif %}>{{ n }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <div class="toolbar">
      <input type="hidden" name="sort" id="sortInput" value="{{ sort }}">
      <input type="hidden" name="dir"  id="dirInput"  value="{{ dir }}">
      <input type="hidden" name="export" id="exportInput" value="">
      <button type="submit">√Åp d·ª•ng</button>
      <a href="{% url 'dashboard' %}" role="button" class="secondary">Reset</a>
      <button type="button" class="secondary" onclick="downloadCSV()">‚¨áÔ∏è T·∫£i CSV</button>
      <span class="muted">K·∫øt qu·∫£: <span class="pill">{{ total_rows }}</span> b·∫£n ghi</span>
    </div>
  </form>

  <!-- Table -->
  <article class="table-card">
    <div class="table-wrap">
      <table role="grid">
        <thead>
          <tr>
            <th class="sortable"><a href="#" onclick="return sortBy('created_at')">Th·ªùi gian {% if sort == 'created_at' %}<span class="pill dir-badge">{{ dir|upper }}</span>{% endif %}</a></th>
            <th class="sortable"><a href="#" onclick="return sortBy('barcode')">Barcode {% if sort == 'barcode' %}<span class="pill dir-badge">{{ dir|upper }}</span>{% endif %}</a></th>
            <th class="sortable"><a href="#" onclick="return sortBy('sku')">SKU {% if sort == 'sku' %}<span class="pill dir-badge">{{ dir|upper }}</span>{% endif %}</a></th>
            <th class="sortable"><a href="#" onclick="return sortBy('action')">Action {% if sort == 'action' %}<span class="pill dir-badge">{{ dir|upper }}</span>{% endif %}</a></th>
            <th class="sortable"><a href="#" onclick="return sortBy('from_wh')">From {% if sort == 'from_wh' %}<span class="pill dir-badge">{{ dir|upper }}</span>{% endif %}</a></th>
            <th class="sortable"><a href="#" onclick="return sortBy('to_wh')">To {% if sort == 'to_wh' %}<span class="pill dir-badge">{{ dir|upper }}</span>{% endif %}</a></th>
            <th class="sortable"><a href="#" onclick="return sortBy('type_action')">Type {% if sort == 'type_action' %}<span class="pill dir-badge">{{ dir|upper }}</span>{% endif %}</a></th>
            <th class="sortable"><a href="#" onclick="return sortBy('note')">Note {% if sort == 'note' %}<span class="pill dir-badge">{{ dir|upper }}</span>{% endif %}</a></th>
          </tr>
        </thead>
        <tbody>
          {% for m in logs %}
            <tr>
              <td>{{ m.created_at|date:"Y-m-d H:i" }}</td>
              <td>{{ m.item.barcode_text }}</td>
              <td>{{ m.item.product.sku }}</td>
              <td>{{ m.action }}</td>
              <td>{% if m.from_wh %}{{ m.from_wh.code }}{% else %}-{% endif %}</td>
              <td>{% if m.to_wh %}{{ m.to_wh.code }}{% else %}-{% endif %}</td>
              <td>{{ m.type_action|default:"-" }}</td>
              <td>{{ m.note }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="8">Ch∆∞a c√≥ log.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </article>
</div>

<script>
  // ---- sort / export gi·ªØ nguy√™n
  function sortBy(key){
    const f=document.getElementById('filterForm');
    const s=document.getElementById('sortInput');
    const d=document.getElementById('dirInput');
    const curS=s.value||'created_at';
    const curD=d.value||'desc';
    if(curS===key){ d.value=(curD==='asc')?'desc':'asc'; }else{ s.value=key; d.value='asc'; }
    f.requestSubmit(); return false;
  }
  function downloadCSV(){
    const f=document.getElementById('filterForm');
    const ex=document.getElementById('exportInput');
    ex.value='csv'; f.submit(); setTimeout(()=>{ex.value=''},0);
  }

  // ---- Date range picker (Litepicker)
  const fmt=(d)=>d.toISOString().slice(0,10);
  const startEl=document.getElementById('startInput');
  const endEl=document.getElementById('endInput');
  const dispEl=document.getElementById('rangeDisplay');
  const wrapEl=document.getElementById('rangeWrap');
  const presetEl=document.getElementById('presetMenu');

  function setDisplay(){
    const s=startEl.value, e=endEl.value;
    dispEl.value=(s&&e)?`${s}  ‚Üí  ${e}`:'';
  }

  document.addEventListener('DOMContentLoaded',()=>{
    const opts={
      element:dispEl,
      singleMode:false,
      numberOfMonths:2,
      numberOfColumns:2,
      autoApply:true,
      format:'YYYY-MM-DD',
      dropdowns:{minYear:2020,maxYear:2035,months:true,years:true},
      startDate:startEl.value||null,
      endDate:endEl.value||null,
      tooltipText:{one:'day',other:'days'},
      tooltipNumber:(n)=>n
    };
    const picker=new Litepicker(opts);

    picker.on('selected',(d1,d2)=>{
      startEl.value=d1?d1.format('YYYY-MM-DD'):'';
      endEl.value=d2?d2.format('YYYY-MM-DD'):'';
      setDisplay();
    });

    // m·ªü/ƒë√≥ng preset menu
    dispEl.addEventListener('focus',()=>wrapEl.classList.add('open'));
    document.addEventListener('click',(e)=>{
      if(!wrapEl.contains(e.target)) wrapEl.classList.remove('open');
    });

    // Presets
    presetEl.querySelectorAll('button').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const now=new Date();
        const today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
        let s=new Date(today), e=new Date(today);
        switch(btn.dataset.preset){
          case 'today': break;
          case 'yesterday': s.setDate(s.getDate()-1); e.setDate(e.getDate()-1); break;
          case 'this_week': {
            const day=(today.getDay()+6)%7; // Mon=0..Sun=6
            s.setDate(s.getDate()-day); e=new Date(s); e.setDate(s.getDate()+6); break;
          }
          case 'last_7': s.setDate(s.getDate()-6); break;
          case 'this_month': s=new Date(today.getFullYear(),today.getMonth(),1);
                             e=new Date(today.getFullYear(),today.getMonth()+1,0); break;
          case 'last_month': s=new Date(today.getFullYear(),today.getMonth()-1,1);
                             e=new Date(today.getFullYear(),today.getMonth(),0); break;
        }
        picker.setDateRange(s,e,true);
        startEl.value=fmt(s); endEl.value=fmt(e); setDisplay();
        wrapEl.classList.remove('open');
      });
    });

    setDisplay();
  });
</script>
{% endblock %}
