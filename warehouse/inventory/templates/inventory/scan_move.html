{% extends "inventory/base.html" %}
{% block title %}Scan & Check{% endblock %}

{% block extra_head %}
<style>
  .subtabs{display:flex;gap:8px;margin:10px 0 0}
  .subtabs a{padding:8px 12px;border:1px solid var(--border);border-radius:10px;text-decoration:none;color:var(--text);background:#0b1220}
  .subtabs a.active{background:#0ea5e9;color:#001018;border-color:#0ea5e9;font-weight:700}

  .scan-wrap{max-width:980px;margin:0 auto}
  .scan-hero{background:linear-gradient(135deg,rgba(14,165,233,.12),rgba(2,132,199,.06));border:1px solid var(--border);border-radius:16px;padding:18px 20px;margin-bottom:18px}
  .scan-hero h2{margin:0;display:flex;align-items:center;gap:10px;font-size:28px}
  .card{background:var(--card-bg);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px}
  .grid4{display:grid;grid-template-columns:1fr 1fr 1fr 120px;gap:12px}
  .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-top:12px}
  .muted{color:var(--muted)}
  .pill{display:inline-flex;gap:8px;align-items:center;background:#0b1220;border:1px solid #263247;padding:8px 12px;border-radius:999px}
  .log ul{margin:0;padding-left:18px}
  .hint{font-size:12px;color:var(--muted);margin-top:4px}
  .nowrap{white-space:nowrap}
</style>
{% endblock %}

{% block content %}
<div class="scan-wrap">
  <div class="scan-hero">
    <h2>üì¶ Scan &amp; Check</h2>
    <div class="subtabs">
      <a href="{% url 'scan_scan' %}" class="{% if subtab == 'scan' %}active{% endif %}">Scan</a>
      <a href="{% url 'scan_check' %}" class="{% if subtab == 'check' %}active{% endif %}">Check</a>
    </div>
  </div>

  {{ tag_map|json_script:"js-tagmap" }}

  <!-- form ·∫©n d√πng cho n√∫t K·∫øt th√∫c ghi (tr√°nh form l·ªìng nhau) -->
  <form id="stopForm" method="post" action="{% url 'scan_stop' %}" style="display:none">
    {% csrf_token %}
  </form>

  <!-- Kh·ªëi 1: B·∫Øt ƒë·∫ßu ghi -->
  <article class="card">
    <form method="post" action="{% url 'scan_start' %}">
      {% csrf_token %}
      <div class="grid4">
        <div>
          <label>Action</label>
          <select name="action" id="f-action" {% if scan_session.active %}disabled{% endif %}>
            <option value="IN"  {% if start_form.initial.action == "IN" %}selected{% endif %}>IN</option>
            <option value="OUT" {% if start_form.initial.action == "OUT" %}selected{% endif %}>OUT</option>
          </select>
        </div>

        <div>
          <label>Action type</label>
          <select name="action_type" id="f-type"
                  data-initial="{{ start_form.initial.action_type|default:'' }}"
                  {% if scan_session.active %}disabled{% endif %}>
            {% if scan_session.active %}
              <option value="{{ scan_session.type_action }}" selected>{{ scan_session.type_action }}</option>
            {% else %}
              {% for val,label in start_form.fields.action_type.choices %}
                <option value="{{ val }}" {% if start_form.initial.action_type == val %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            {% endif %}
          </select>
        </div>

        <div>
          <label id="wh-label">Kho</label>
          <select name="wh" id="f-wh" {% if scan_session.active %}disabled{% endif %}>
            <option value="">-- Ch·ªçn kho --</option>
            {% for wh in start_form.fields.wh.queryset %}
              <option value="{{ wh.id }}" {% if scan_session.wh_id == wh.id %}selected{% endif %}>{{ wh.code }}</option>
            {% endfor %}
          </select>
          <div class="hint" id="tag-hint" aria-live="polite"></div>
        </div>

        <div>
          <label>ƒê·ª£t</label>
          <select name="tag" id="f-tag"
                  data-initial="{{ start_form.initial.tag|default:'' }}"
                  {% if scan_session.active %}disabled{% endif %}></select>
        </div>
      </div>

      <div class="actions">
        {% if scan_session.active %}
          <span class="pill nowrap">ƒê·ª£t: <strong>#{{ scan_session.tag }}</strong></span>
          <span class="muted">Kho√° c·∫•u h√¨nh ‚Äî ƒëang ghi.</span>
          <button type="submit" disabled>ƒêang ghi...</button>
          <button type="submit" form="stopForm" class="secondary">‚èπÔ∏è K·∫øt th√∫c ghi</button>
        {% else %}
          <button type="submit">‚ñ∂Ô∏è B·∫Øt ƒë·∫ßu ghi</button>
          <span class="muted">Ch·ªçn action / type / kho. ƒê·ª£t s·∫Ω t·ª± nh·∫£y theo kho + ng√†y.</span>
        {% endif %}
      </div>
    </form>
  </article>

  <!-- Kh·ªëi 2: Qu√©t barcode -->
  <article class="card">
    <!-- ‚§µÔ∏è ƒë·ªïi action sang scan_scan ƒë·ªÉ post ƒë√∫ng /scan-check/scan -->
    <form method="post" action="{% url 'scan_scan' %}" id="scanForm">
      {% csrf_token %}
      <label>Barcode</label>
      <input name="barcode" id="f-barcode" placeholder="Qu√©t barcode..." {% if not scan_session.active %}disabled{% endif %} autofocus>
      <div class="actions">
        <button type="submit" {% if not scan_session.active %}disabled{% endif %}>Ghi</button>
        <button type="button" class="secondary" onclick="document.getElementById('f-barcode').select();" {% if not scan_session.active %}disabled{% endif %}>Ch·ªçn l·∫°i</button>
      </div>
      <div class="log">
        <small class="muted">ƒê√£ qu√©t (g·∫ßn ƒë√¢y nh·∫•t):</small>
        <ul>
          {% for c in scan_session.scanned %}
            <li>{{ c }}</li>
          {% empty %}
            <li class="muted">Ch∆∞a c√≥ m√£ n√†o trong phi√™n.</li>
          {% endfor %}
        </ul>
      </div>
    </form>
  </article>
</div>

<script>
/* Nh√£n kho ƒë·ªïi theo Action */
(function(){
  const active = {{ scan_session.active|yesno:"true,false" }};
  const actEl = document.getElementById('f-action');
  const whLabel = document.getElementById('wh-label');
  function setLabel(){
    const v = (actEl.value||'IN').toUpperCase();
    whLabel.textContent = v === 'IN' ? 'Kho (nh·∫≠p v√†o)' : 'Kho (xu·∫•t t·ª´)';
  }
  if (!active) { actEl.addEventListener('change', setLabel); }
  setLabel();
})();

/* Action type: ƒë·ªï options theo Action, gi·ªØ l·∫°i gi√° tr·ªã hi·ªán c√≥ n·∫øu c√≤n h·ª£p l·ªá */
(function(){
  const active = {{ scan_session.active|yesno:"true,false" }};
  if (active) return;
  const MAP = {
    IN:  [["purchase","Nh·∫≠p mua"],["return_in","Kh√°ch tr·∫£"],["adjust_in","ƒêi·ªÅu ch·ªânh +"]],
    OUT: [["sale","Xu·∫•t b√°n"],["return_supplier","Tr·∫£ NCC"],["adjust_out","ƒêi·ªÅu ch·ªânh -"]],
  };
  const fAct = document.getElementById('f-action');
  const fType = document.getElementById('f-type');
  const initial = fType.dataset.initial || "";

  function refillType(){
    const k=(fAct.value||"IN").toUpperCase(), opts=MAP[k]||[];
    const prev = fType.value || initial;
    fType.innerHTML="";
    let hasPrev = false;
    opts.forEach(([v,t])=>{
      const o=document.createElement("option"); o.value=v; o.textContent=t;
      if (v===prev) { o.selected = true; hasPrev = true; }
      fType.appendChild(o);
    });
    if (!hasPrev && opts.length){ fType.options[0].selected = true; }
  }
  fAct.addEventListener('change', refillType);
  refillType();
})();

/* ƒê·ª£t theo kho + action: 1..(max+1) ‚Äî gi·ªØ l·∫°i gi√° tr·ªã ƒëang c√≥ n·∫øu h·ª£p l·ªá */
(function(){
  const active = {{ scan_session.active|yesno:"true,false" }};
  if (active) return;

  const TAGMAP = JSON.parse(document.getElementById('js-tagmap').textContent || '{}');
  const fAct = document.getElementById('f-action');
  const fWh  = document.getElementById('f-wh');
  const fTag = document.getElementById('f-tag');
  const hint = document.getElementById('tag-hint');
  const initial = parseInt(fTag.dataset.initial || "0", 10);

  function refillTag(){
    const wh = fWh.value;
    const act = (fAct.value||"IN").toUpperCase();
    fTag.innerHTML = "";
    hint.textContent = "";

    if (!wh) { fTag.disabled = true; return; }

    const max = TAGMAP[`${act}-${wh}`] || 0;
    const upto = max + 1; // cho ch·ªçn 1..max+1
    for (let i=1; i<=upto; i++){
      const o=document.createElement('option'); o.value=i; o.textContent=i; fTag.appendChild(o);
    }
    fTag.disabled = false;

    const want = (initial && initial>=1 && initial<=upto) ? initial : upto;
    fTag.value = String(want);

    hint.textContent = `H√¥m nay kho ƒë√£ c√≥ ${max} ƒë·ª£t ${act}.`;
  }

  fAct.addEventListener('change', refillTag);
  fWh.addEventListener('change', refillTag);
  refillTag();
})();

/* Auto submit barcode (d·ª± ph√≤ng n·∫øu scanner kh√¥ng g·ª≠i Enter) */
(function(){
  const b=document.getElementById('f-barcode');
  if (!b || b.disabled) return;
  const form=document.getElementById('scanForm');
  let t; b.addEventListener('input', ()=>{ clearTimeout(t); if (b.value.length>=4) t=setTimeout(()=>form.submit(),200); });
  setTimeout(()=>{ b.focus(); b.select?.(); }, 100);
})();
</script>
{% endblock %}
