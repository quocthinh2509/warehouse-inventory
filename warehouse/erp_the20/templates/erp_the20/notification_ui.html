<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP The20 ‚Ä¢ Th√¥ng b√°o</title>
  <style>
    :root{
      --bg:#0f1115;--panel:#151922;--border:#2a3140;--text:#e6eefc;--muted:#8a93a6;--primary:#4f8cff;
      --ok:#2ecc71;--warn:#f1c40f;--bad:#ff5c5c;--ink:#0f131a;--chip:#0c0f15
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Segoe UI,Roboto}
    .wrap{max-width:1200px;margin:26px auto;padding:0 16px}

    /* Tabs */
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab-btn{padding:10px 14px;border:1px solid var(--border);background:var(--panel);color:var(--text);border-radius:10px;cursor:pointer}
    .tab-btn.active{background:var(--primary);border-color:transparent;color:#fff}
    .tab-panel{display:none}
    .tab-panel.active{display:block}

    /* Cards & layout */
    .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
    h1{margin:0 0 10px 0;font-size:1.25rem}
    h2{margin:0 0 12px 0;font-size:1rem;color:var(--muted)}
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:.9rem}
    input,textarea,select,button{
      width:100%;padding:10px 12px;background:var(--ink);border:1px solid var(--border);border-radius:8px;color:var(--text)
    }
    textarea{resize:vertical;min-height:120px}
    button{cursor:pointer;background:var(--primary);border:none;color:#fff}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row > *{flex:1}
    .muted{color:var(--muted)}
    .msg{margin-top:8px;color:#a9b4cc;font-size:.9rem}
    .sep{height:1px;background:var(--border);margin:12px 0}

    /* Inbox list */
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:10px}
    .toolbar .grow{flex:1}
    .toolbar .shrink{flex:0 0 auto;width:auto}
    .list{display:grid;gap:10px}
    .notif{border:1px solid var(--border);border-radius:10px;padding:12px;background:var(--ink)}
    .notif h3{margin:0 0 6px 0;font-size:1rem}
    .notif .meta{font-size:.82rem;color:#9aa6bf;display:flex;gap:10px;flex-wrap:wrap;margin-top:6px}
    .notif .payload{margin-top:8px;white-space:pre-wrap}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}

    /* Pills / chips */
    .pill{display:inline-flex;align-items:center;gap:6px;font-size:.75rem;border:1px solid var(--border);border-radius:999px;padding:2px 10px;background:var(--chip)}
    .pill.ok{background:#12331f;color:#8fe9b8;border-color:#1d5a39}
    .pill.warn{background:#2b2b16;color:#efe3a1;border-color:#6a5f2a}
    .pill.bad{background:#3a1720;color:#ff9fb1;border-color:#6e2536}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:#27ae60}
    .dot.warn{background:#f1c40f}
    .dot.bad{background:#ff5c5c}

    /* Key-Value grid */
    .kv{display:grid;grid-template-columns:140px 1fr;gap:6px 12px;margin-top:8px}
    .kv .k{color:var(--muted)}

    /* Tiny actions */
    .tiny{font-size:.82rem}
    .btn-ghost{background:transparent;border:1px dashed var(--border);color:var(--text)}
  </style>
</head>
<body>
<div class="wrap">
  <div class="tabs">
    <button class="tab-btn active" data-tab="inbox">üì• Th√¥ng b√°o</button>
    <button class="tab-btn" data-tab="compose">üì¢ G·ª≠i th√¥ng b√°o</button>
  </div>

  <!-- ===================== INBOX TAB ===================== -->
  <div id="tab-inbox" class="tab-panel active">
    <div class="card">
      <h1>üì• H·ªôp th√¥ng b√°o</h1>
      <div class="toolbar">
        <div class="grow row">
          <input id="filterUserId" placeholder="L·ªçc theo user_id (v√≠ d·ª•: 117)"/>
          <input id="searchTitle" placeholder="T√¨m theo ti√™u ƒë·ªÅ (client-side)"/>
        </div>
        <div class="row">
          <select id="filterChannel" title="K√™nh">
            <option value="">K√™nh: T·∫•t c·∫£</option>
            <option value="INAPP">INAPP</option>
            <option value="EMAIL">EMAIL</option>
            <option value="LARK">LARK</option>
          </select>
          <select id="filterType" title="Object type">
            <option value="">Lo·∫°i: T·∫•t c·∫£</option>
            <option value="proposal">proposal</option>
            <option value="handover">handover</option>
          </select>
          <select id="filterDelivered" title="Tr·∫°ng th√°i g·ª≠i">
            <option value="">Tr·∫°ng th√°i: T·∫•t c·∫£</option>
            <option value="true">ƒê√£ g·ª≠i</option>
            <option value="false">Ch∆∞a g·ª≠i</option>
          </select>
        </div>
        <div class="row">
          <button id="refreshBtn" class="shrink">L√†m m·ªõi</button>
          <button id="clearFiltersBtn" class="btn-ghost shrink">Xo√° l·ªçc</button>
        </div>
      </div>

      <div id="inboxMsg" class="msg muted">S·ª≠ d·ª•ng n√∫t ‚ÄúL√†m m·ªõi‚Äù ƒë·ªÉ t·∫£i danh s√°ch.</div>
      <div id="notifList" class="list"></div>

      <div class="sep"></div>
      <div class="row">
        <button id="prevBtn" class="shrink" disabled>‚Üê Trang tr∆∞·ªõc</button>
        <div id="pageInfo" class="muted" style="flex:1;text-align:center"></div>
        <button id="nextBtn" class="shrink" disabled>Trang sau ‚Üí</button>
      </div>
    </div>
  </div>

  <!-- ===================== COMPOSE TAB ===================== -->
  <div id="tab-compose" class="tab-panel">
    <div class="card">
      <h1>üì¢ G·ª≠i th√¥ng b√°o n·ªôi b·ªô</h1>
      <div class="row">
        <div style="flex:1">
          <label>Ti√™u ƒë·ªÅ</label>
          <input id="title" placeholder="VD: C·∫≠p nh·∫≠t h·ªçp tu·∫ßn n√†y"/>
        </div>
        <div style="flex:1">
          <label>Danh s√°ch ng∆∞·ªùi nh·∫≠n (IDs, c√°ch nhau b·∫±ng d·∫•u ph·∫©y)</label>
          <input id="recipients" placeholder="VD: 101, 117, 123"/>
        </div>
      </div>

      <label>N·ªôi dung (text)</label>
      <textarea id="body" placeholder="Nh·∫≠p n·ªôi dung th√¥ng b√°o..."></textarea>

      <div class="row">
        <label class="tiny" style="display:flex;align-items:center;gap:8px;flex:0 0 auto;width:auto;margin:0">
          <input id="send_email" type="checkbox" style="width:auto"> G·ª≠i k√®m Email
        </label>
        <label class="tiny" style="display:flex;align-items:center;gap:8px;flex:0 0 auto;width:auto;margin:0">
          <input id="send_lark" type="checkbox" style="width:auto"> G·ª≠i k√®m Lark
        </label>
      </div>
      <div class="msg muted">N·∫øu b·∫≠t Email/Lark, h·ªá th·ªëng s·∫Ω t·ª± d√πng <b>ti√™u ƒë·ªÅ = Title</b> v√† <b>n·ªôi dung = Body</b> (kh√¥ng c·∫ßn nh·∫≠p ri√™ng).</div>

      <div class="row">
        <button id="sendBtn">G·ª≠i th√¥ng b√°o</button>
        <button id="previewBtn" class="btn-ghost">Xem JSON g·ª≠i</button>
      </div>
      <div id="sendMsg" class="msg"></div>
      <pre id="previewBox" class="msg" style="display:none;white-space:pre-wrap"></pre>
    </div>
  </div>
</div>

<script>
  // ================== CONFIG ==================
  const API_LIST = '/the20/notifications/';        // GET
  const API_SEND = '/the20/notifications/send/';   // POST

  // ================== Helpers ==================
  const $  = (s,r=document)=>r.querySelector(s);
  const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
  const fmtDate = s=>{ if(!s) return ''; try{ const d=new Date(s); return d.toLocaleString(); }catch(_){ return s; } };
  const esc = s => String(s).replace(/[&<>]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[c]||c));

  const CHANNEL_MAP = {
    0: 'INAPP', 1: 'EMAIL', 2: 'SMS', 3: 'LARK'
  };

  function badgeDelivered(n){
    if(n.delivered === true)  return `<span class="pill ok"><span class="dot ok"></span> ƒë√£ g·ª≠i</span>`;
    if(n.delivered === false) return `<span class="pill warn"><span class="dot warn"></span> ƒëang ch·ªù</span>`;
    return `<span class="pill warn"><span class="dot warn"></span> n/a</span>`;
  }

  function deriveChannel(n){
    if(typeof n.channel_display !== 'undefined' && n.channel_display) return n.channel_display;
    if(typeof n.channel === 'number') return CHANNEL_MAP[n.channel] || String(n.channel);
    return 'INAPP';
  }

  function deriveBody(n){
    if(!n.payload) return '';
    const p = n.payload;
    // Prefer human-readable fields
    const t = p.body || p.text || p.message || '';
    return t;
  }

  // ================== STATE (pagination aware) ==================
  let currentPage = 1;
  let nextUrl = null;
  let prevUrl = null;
  let lastData = []; // normalized array of notifications (for client-side filter)

  // ================== RENDER LIST ==================
  function renderList() {
    const list = $('#notifList');
    const qTitle = $('#searchTitle').value.trim().toLowerCase();
    const qCh = $('#filterChannel').value;
    const qType = $('#filterType').value;
    const qDelivered = $('#filterDelivered').value;

    let filtered = lastData.slice();
    if(qTitle) filtered = filtered.filter(x => (x.title||'').toLowerCase().includes(qTitle));
    if(qCh)    filtered = filtered.filter(x => (deriveChannel(x) === qCh));
    if(qType)  filtered = filtered.filter(x => (x.object_type||'') === qType);
    if(qDelivered) filtered = filtered.filter(x => String(!!x.delivered) === (qDelivered === 'true'));

    list.innerHTML = '';
    if (filtered.length === 0) {
      $('#inboxMsg').textContent = 'Kh√¥ng c√≥ th√¥ng b√°o ph√π h·ª£p.';
      return;
    }
    $('#inboxMsg').textContent = `T·ªïng ${filtered.length} th√¥ng b√°o (ƒëang hi·ªÉn th·ªã theo trang c·ªßa server).`;

    for (const n of filtered) {
      const recipients = Array.isArray(n.recipients) ? n.recipients.join(', ') : '';
      const bodyText = deriveBody(n);
      const chan = deriveChannel(n);

      const errorPill = (n.last_error && String(n.last_error).trim())
        ? `<span class="pill bad" title="${esc(n.last_error)}"><span class="dot bad"></span> l·ªói</span>`
        : '';

      const header = `
        <div class="row" style="align-items:flex-start">
          <h3 style="flex:1">${esc(n.title||'')}</h3>
          <div class="row" style="flex:0 0 auto;gap:6px">
            ${badgeDelivered(n)}
            <span class="pill">${esc(chan)}</span>
            ${errorPill}
          </div>
        </div>`;

      const kv = `
        <div class="kv tiny">
          <div class="k">ID</div><div>#${n.id}</div>
          <div class="k">ƒê·ªëi t∆∞·ª£ng</div><div>${esc(n.object_type||'-')}${n.object_id?` <span class="mono">#${esc(n.object_id)}</span>`:''}</div>
          <div class="k">Ng∆∞·ªùi nh·∫≠n</div><div>${recipients?`[${esc(recipients)}]`:'-'}</div>
          <div class="k">to_user</div><div>${n.to_user ?? '-'}</div>
          <div class="k">attempts</div><div>${n.attempt_count ?? 0}</div>
          <div class="k">created</div><div>${esc(fmtDate(n.created_at))}</div>
          <div class="k">delivered</div><div>${esc(fmtDate(n.delivered_at))}</div>
        </div>`;

      const payloadBlock = bodyText
        ? `<div class="payload">${esc(bodyText)}</div>`
        : '';

      const html = `
        <div class="notif">
          ${header}
          ${payloadBlock}
          <div class="meta">${kv}</div>
        </div>`;

      list.insertAdjacentHTML('beforeend', html);
    }
  }

  // ================== LOAD LIST ==================
  async function loadList(pageUrl=null) {
    $('#inboxMsg').textContent = 'ƒêang t·∫£i...';
    const userId = $('#filterUserId').value.trim();
    let url = pageUrl || API_LIST;
    if (!pageUrl && userId) {
      const p = new URLSearchParams({ user_id: userId });
      url = `${API_LIST}?${p.toString()}`;
    }
    try{
      const res = await fetch(url, {headers:{'accept':'application/json'}});
      if(!res.ok){
        const err = await res.text().catch(()=>res.statusText);
        $('#inboxMsg').textContent = `‚ùå L·ªói t·∫£i danh s√°ch: ${err}`;
        $('#notifList').innerHTML = '';
        return;
      }
      const data = await res.json();
      // DRF c√≥ th·ªÉ tr·∫£ v·ªÅ {results, next, previous} ho·∫∑c 1 m·∫£ng thu·∫ßn
      const arr = Array.isArray(data) ? data : (data.results || []);
      lastData = arr;

      // pagination info
      nextUrl = (data && data.next) ? data.next : null;
      prevUrl = (data && data.previous) ? data.previous : null;
      $('#nextBtn').disabled = !nextUrl;
      $('#prevBtn').disabled = !prevUrl;
      $('#pageInfo').textContent = (nextUrl || prevUrl) ? `Trang hi·ªán t·∫°i: ${currentPage}` : '';

      renderList();
    }catch(e){
      $('#inboxMsg').textContent = '‚ùå L·ªói k·∫øt n·ªëi khi t·∫£i danh s√°ch.';
      $('#notifList').innerHTML = '';
    }
  }

  // ================== SEND ==================
  function buildPayload(){
    const title = $('#title').value.trim();
    const recips = $('#recipients').value.split(',').map(x=>parseInt(x.trim(),10)).filter(x=>!Number.isNaN(x));
    const body = $('#body').value.trim();

    const sendEmail = $('#send_email')?.checked || false;
    const sendLark  = $('#send_lark')?.checked  || false;

    const payload = { title, recipients: recips, payload: {} };
    if(body) payload.payload.body = body;

    // T·ª± ƒë·ªông suy di·ªÖn n·ªôi dung k√™nh ph·ª• d·ª±a tr√™n title/body
    if(sendEmail){
      payload.email_subject = title || '[ERP] Th√¥ng b√°o';
      payload.email_text    = body || title || '[ERP] Th√¥ng b√°o';
    }
    if(sendLark){
      payload.lark_text = body || title || '[ERP] Th√¥ng b√°o';
    }
    return payload;
  }

  async function doSend(){
    const payload = buildPayload();
    if(!payload.title){ $('#sendMsg').textContent='‚ö†Ô∏è Nh·∫≠p ti√™u ƒë·ªÅ'; return; }

    $('#sendBtn').disabled = true;
    $('#sendMsg').textContent = 'ƒêang g·ª≠i...';
    try{
      const res = await fetch(API_SEND,{
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=>({}));
      if(res.ok){
        $('#sendMsg').textContent = '‚úÖ G·ª≠i th√†nh c√¥ng';
        // refresh inbox ƒë·ªÉ th·∫•y th√¥ng b√°o v·ª´a t·∫°o (n·∫øu user_id ph√π h·ª£p)
        loadList();
      }else{
        $('#sendMsg').textContent = '‚ùå L·ªói g·ª≠i: ' + (data.detail || JSON.stringify(data));
      }
    }catch(e){
      $('#sendMsg').textContent = '‚ùå L·ªói k·∫øt n·ªëi khi g·ª≠i.';
    }finally{
      $('#sendBtn').disabled = false;
    }
  }

  // ================== TABS ==================
  function switchTab(name){
    $$('.tab-btn').forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
    $('#tab-inbox').classList.toggle('active', name==='inbox');
    $('#tab-compose').classList.toggle('active', name==='compose');
  }

  // ================== BINDINGS ==================
  // Tabs
  $$('.tab-btn').forEach(btn=> btn.addEventListener('click', ()=> switchTab(btn.dataset.tab)) );

  // Inbox
  $('#refreshBtn').onclick = ()=>{ currentPage=1; loadList(); };
  $('#nextBtn').onclick = ()=>{ if(nextUrl){ currentPage++; loadList(nextUrl); } };
  $('#prevBtn').onclick = ()=>{ if(prevUrl){ currentPage=Math.max(1,currentPage-1); loadList(prevUrl); } };
  $('#searchTitle').oninput = ()=> renderList();
  $('#filterChannel').onchange = ()=> renderList();
  $('#filterType').onchange = ()=> renderList();
  $('#filterDelivered').onchange = ()=> renderList();
  $('#clearFiltersBtn').onclick = ()=>{
    $('#filterUserId').value='';
    $('#searchTitle').value='';
    $('#filterChannel').value='';
    $('#filterType').value='';
    $('#filterDelivered').value='';
    renderList();
  };

  // Compose
  $('#sendBtn').onclick = doSend;
  $('#previewBtn').onclick = ()=>{
    const payload = buildPayload();
    const box = $('#previewBox');
    box.textContent = JSON.stringify(payload, null, 2);
    box.style.display = 'block';
  };

  // Auto boot
  loadList();
</script>
</body>
</html>
