<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Shift Templates – Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{--bg:#0b1020;--panel:#131a2a;--muted:#a7b0c0;--fg:#f2f5fa;--accent:#6ea8fe;--red:#ff6b6b;--green:#51cf66;--border:#223}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif}
    .container{max-width:1100px;margin:32px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px;box-shadow:0 6px 20px rgba(0,0,0,.25)}
    h1{font-size:24px;margin:0 0 12px}
    .muted{color:var(--muted);font-size:13px}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:8px;flex-wrap:wrap}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    input[type="text"],select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a3348;background:#0f1626;color:var(--fg);outline:none}
    input[type="checkbox"]{transform:scale(1.1)}
    button{border:0;padding:10px 14px;border-radius:10px;background:var(--accent);color:#0b0f1a;font-weight:600;cursor:pointer}
    button.ghost{background:transparent;border:1px solid #2a3348;color:var(--fg)}
    button.secondary{background:#394566;color:var(--fg)}
    button.danger{background:var(--red);color:#000}
    button.success{background:var(--green);color:#001}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left;font-size:14px}
    th{color:#cdd6e8;font-weight:600}
    .actions{display:flex;gap:6px;flex-wrap:wrap}
    .error{background:#3c1f1f;color:#ffd7d7;border:1px solid #5d2a2a;padding:8px 10px;border-radius:8px;margin-top:8px;display:none}
    .ok{background:#163321;color:#b8f7c4;border:1px solid #245a35;padding:8px 10px;border-radius:8px;margin-top:8px;display:none}
    .pagebar{display:flex;gap:10px;align-items:center;margin-top:10px}
    /* Add-row */
    .add-row{cursor:pointer}
    .add-cell{display:flex;align-items:center;gap:8px;color:#bcd}
    .add-cell svg{width:18px;height:18px;flex:0 0 18px}
    .add-cell:hover{color:#fff}
    /* Modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:50}
    .modal{width:min(560px,92vw);background:#0e1628;border:1px solid #2a3348;border-radius:14px;box-shadow:0 10px 40px rgba(0,0,0,.5);padding:16px}
    .modal h2{margin:0 0 10px;font-size:18px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .grid > div{display:flex;flex-direction:column;gap:6px}
    .modal label{font-size:12px;color:#cfd7e6}
    .modal input[type="text"], .modal input[type="time"], .modal input[type="number"], .modal select{padding:10px 12px;border-radius:10px;border:1px solid #2a3348;background:#0f1626;color:var(--fg);outline:none}
    .modal .footer{display:flex;justify-content:flex-end;gap:8px;margin-top:12px}
    @media (max-width:800px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <h1>Shift Templates</h1>

      <div class="toolbar">
        <div class="row" style="flex:1">
          <input id="q" type="text" placeholder="Tìm theo code / name..." style="min-width:240px">
          <select id="overnightFilter">
            <option value="">Overnight: Any</option>
            <option value="true">Overnight: True</option>
            <option value="false">Overnight: False</option>
          </select>
          <select id="ordering">
            <option value="">Sắp xếp</option>
            <option value="code">code ↑</option>
            <option value="-code">code ↓</option>
            <option value="created_at">created_at ↑</option>
            <option value="-created_at">created_at ↓</option>
          </select>
          <label class="row" style="user-select:none">
            <input id="includeDeleted" type="checkbox"> <span class="muted">Hiện bản đã xoá (soft)</span>
          </label>
        </div>
        <div class="row">
          <button id="reloadBtn" class="secondary">Reload</button>
        </div>
      </div>

      <div id="alertError" class="error"></div>
      <div id="alertOk" class="ok"></div>

      <table id="listTable">
        <thead>
          <tr>
            <th style="width:70px">ID</th>
            <th style="width:120px">Code</th>
            <th>Name</th>
            <th style="width:110px">Start</th>
            <th style="width:110px">End</th>
            <th style="width:90px">Break</th>
            <th style="width:110px">Overnight</th>
            <th style="width:220px">Actions</th>
          </tr>
        </thead>
        <tbody id="listBody">
          <tr><td colspan="8" class="muted">Đang tải...</td></tr>
        </tbody>
        <!-- Dòng tạo mới -->
        <tfoot>
          <tr class="add-row" id="addRow">
            <td colspan="8">
              <div class="add-cell">
                <svg viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
                <span>Thêm ca mới</span>
              </div>
            </td>
          </tr>
        </tfoot>
      </table>

      <div class="pagebar">
        <button id="prevBtn" class="ghost">← Prev</button>
        <span id="pageHint" class="muted"></span>
        <button id="nextBtn" class="ghost">Next →</button>
      </div>
    </div>
  </div>

  <!-- ===== Modal (Create / Edit) ===== -->
  <div id="modalBackdrop" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <h2 id="modalTitle">Tạo ca</h2>
      <form id="modalForm" onsubmit="return false;">
        <input type="hidden" id="editId" />
        <div class="grid">
          <div>
            <label for="code">Code</label>
            <input id="code" type="text" maxlength="16" required />
          </div>
          <div>
            <label for="name">Name</label>
            <input id="name" type="text" maxlength="120" required />
          </div>
          <div>
            <label for="start_time">Start Time</label>
            <input id="start_time" type="time" required />
          </div>
          <div>
            <label for="end_time">End Time</label>
            <input id="end_time" type="time" required />
          </div>
          <div>
            <label for="break_minutes">Break Minutes</label>
            <input id="break_minutes" type="number" min="0" max="480" step="1" value="0" />
          </div>
          <div>
            <label for="overnight">Overnight</label>
            <select id="overnight">
              <option value="false">False</option>
              <option value="true">True</option>
            </select>
          </div>
        </div>
        <div class="footer">
          <button type="button" class="ghost" id="btnCancel">Hủy</button>
          <button type="submit" id="btnSubmit">Lưu</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const API_BASE = "http://127.0.0.1:8000/the20/shifts/templates/";
    let nextUrl = null, prevUrl = null;

    // CSRF cookie (SessionAuth)
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== "") {
        const cookies = document.cookie.split(";");
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + "=")) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    const csrftoken = getCookie("csrftoken");

    // ===== Utils =====
    function show(el){ el.style.display = "flex"; el.setAttribute("aria-hidden","false"); }
    function hide(el){ el.style.display = "none"; el.setAttribute("aria-hidden","true"); }
    function showError(msg){
      const el = document.getElementById("alertError");
      el.style.display="block";
      el.textContent = typeof msg === "string" ? msg : JSON.stringify(msg);
      setTimeout(()=>{ el.style.display="none"; }, 5000);
    }
    function showOk(msg){
      const el = document.getElementById("alertOk");
      el.style.display="block";
      el.textContent = msg;
      setTimeout(()=>{ el.style.display="none"; }, 3000);
    }
    function buildListUrl(base=API_BASE){
      const q = document.getElementById("q").value.trim();
      const overnight = document.getElementById("overnightFilter").value;
      const ordering = document.getElementById("ordering").value;
      const includeDeleted = document.getElementById("includeDeleted").checked;
      const params = new URLSearchParams();
      if (q) params.set("q", q);
      if (overnight) params.set("overnight", overnight);
      if (ordering) params.set("ordering", ordering);
      if (includeDeleted) params.set("include_deleted","true");
      return base + (params.toString() ? `?${params.toString()}` : "");
    }

    // ===== Data =====
    async function loadList(url=null){
      try{
        const endpoint = url || buildListUrl();
        const res = await fetch(endpoint, { credentials:"same-origin" });
        if(!res.ok) throw await res.json().catch(()=>({detail: res.statusText}));
        const data = await res.json();
        const results = Array.isArray(data) ? data : (data.results || []);
        nextUrl = data.next || null;
        prevUrl = data.previous || null;
        document.getElementById("pageHint").textContent = (data.count !== undefined) ? `Tổng: ${data.count}` : "";
        renderTable(results);
      }catch(e){ showError(e.detail || e); }
    }

    function renderTable(items){
      const tbody = document.getElementById("listBody");
      tbody.innerHTML = "";
      if(!items.length){
        tbody.innerHTML = `<tr><td colspan="8" class="muted">Không có dữ liệu.</td></tr>`;
        return;
      }
      for(const it of items){
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${it.id}</td>
          <td><code>${it.code}</code></td>
          <td>${it.name}</td>
          <td>${it.start_time || ""}</td>
          <td>${it.end_time || ""}</td>
          <td>${it.break_minutes ?? 0}</td>
          <td>${it.overnight ? "✓" : ""}</td>
          <td class="actions">
            <button class="ghost" data-action="edit" data-id="${it.id}">Edit</button>
            <button class="danger" data-action="delete" data-id="${it.id}">Delete</button>
            <button class="success" data-action="restore" data-id="${it.id}">Restore</button>
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    async function loadDetail(id){
      const res = await fetch(`${API_BASE}${id}/`, { credentials: "same-origin" });
      if(!res.ok) throw await res.json().catch(()=>({detail: res.statusText}));
      return await res.json();
    }

    // ===== Modal logic =====
    const backdrop = document.getElementById("modalBackdrop");
    const modalTitle = document.getElementById("modalTitle");
    const form = document.getElementById("modalForm");

    function openCreate(){
      modalTitle.textContent = "Tạo ca";
      form.reset();
      document.getElementById("editId").value = "";
      document.getElementById("break_minutes").value = "0";
      document.getElementById("overnight").value = "false";
      show(backdrop);
      setTimeout(()=>document.getElementById("code").focus(), 0);
    }

    async function openEdit(id){
      try{
        const it = await loadDetail(id);
        modalTitle.textContent = `Chỉnh sửa #${id}`;
        document.getElementById("editId").value = it.id;
        document.getElementById("code").value = it.code || "";
        document.getElementById("name").value = it.name || "";
        document.getElementById("start_time").value = (it.start_time || "").slice(0,5);
        document.getElementById("end_time").value = (it.end_time || "").slice(0,5);
        document.getElementById("break_minutes").value = it.break_minutes ?? 0;
        document.getElementById("overnight").value = it.overnight ? "true" : "false";
        show(backdrop);
        setTimeout(()=>document.getElementById("name").focus(), 0);
      }catch(e){ showError(e.detail || e); }
    }

    function closeModal(){ hide(backdrop); }

    async function submitModal(){
      const id = document.getElementById("editId").value.trim();
      const payload = {
        code: document.getElementById("code").value.trim(),
        name: document.getElementById("name").value.trim(),
        start_time: document.getElementById("start_time").value + ":00",
        end_time: document.getElementById("end_time").value + ":00",
        break_minutes: Number(document.getElementById("break_minutes").value || 0),
        overnight: document.getElementById("overnight").value === "true",
      };
      const opts = {
        method: id ? "PATCH" : "POST",
        credentials: "same-origin",
        headers: {"Content-Type":"application/json","X-CSRFToken": csrftoken},
        body: JSON.stringify(payload),
      };
      try{
        const url = id ? `${API_BASE}${id}/` : API_BASE;
        const res = await fetch(url, opts);
        const data = await res.json().catch(()=>({}));
        if(!res.ok) throw data;
        showOk(id ? "Cập nhật thành công." : "Tạo mới thành công.");
        closeModal();
        await loadList();
      }catch(e){ showError(e.detail || e.code || JSON.stringify(e)); }
    }

    async function softDelete(id){
      if(!confirm("Xóa mềm bản ghi này?")) return;
      try{
        const res = await fetch(`${API_BASE}${id}/`, {
          method:"DELETE", credentials:"same-origin", headers:{"X-CSRFToken": csrftoken}
        });
        if(!res.ok) throw await res.json().catch(()=>({detail: res.statusText}));
        showOk("Đã xóa mềm.");
        await loadList();
      }catch(e){ showError(e.detail || e); }
    }

    async function restore(id){
      try{
        const res = await fetch(`${API_BASE}${id}/restore/`, {
          method:"POST", credentials:"same-origin", headers:{"X-CSRFToken": csrftoken}
        });
        const data = await res.json().catch(()=>({}));
        if(!res.ok) throw data;
        showOk("Đã khôi phục.");
        await loadList();
      }catch(e){ showError(e.detail || e); }
    }

    // ===== Events =====
    document.getElementById("reloadBtn").addEventListener("click", ()=>loadList());
    document.getElementById("q").addEventListener("keydown", (e)=>{ if(e.key==="Enter") loadList(); });
    document.getElementById("overnightFilter").addEventListener("change", ()=>loadList());
    document.getElementById("ordering").addEventListener("change", ()=>loadList());
    document.getElementById("includeDeleted").addEventListener("change", ()=>loadList());

    document.getElementById("listBody").addEventListener("click",(e)=>{
      const btn = e.target.closest("button");
      if(!btn) return;
      const id = btn.getAttribute("data-id");
      const action = btn.getAttribute("data-action");
      if(action === "edit") openEdit(id);
      if(action === "delete") softDelete(id);
      if(action === "restore") restore(id);
    });

    document.getElementById("prevBtn").addEventListener("click", ()=>{ if(prevUrl) loadList(prevUrl); });
    document.getElementById("nextBtn").addEventListener("click", ()=>{ if(nextUrl) loadList(nextUrl); });

    document.getElementById("addRow").addEventListener("click", openCreate);
    document.getElementById("btnCancel").addEventListener("click", closeModal);
    document.getElementById("modalForm").addEventListener("submit", submitModal);

    // Đóng modal bằng ESC hoặc click ra ngoài
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeModal(); });
    document.getElementById("modalBackdrop").addEventListener("click",(e)=>{
      if(e.target.id === "modalBackdrop") closeModal();
    });

    // First load
    loadList();
  </script>
</body>
</html>
