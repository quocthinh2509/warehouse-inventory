<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ERP The20 ‚Ä¢ ƒê·ªÅ xu·∫•t</title>
<style>
  :root{
    --bg:#0f1115;--panel:#151922;--ink:#0f131a;--border:#2a3140;--text:#e6eefc;--muted:#8a93a6;--primary:#4f8cff;--bad:#e74c3c;
    --pill:#0c0f15;
  }
  body{background:var(--bg);color:var(--text);font-family:system-ui;margin:0}
  .wrap{max-width:1200px;margin:28px auto;padding:0 16px}

  /* Tabs */
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:10px 14px;border:1px solid var(--border);border-radius:10px;cursor:pointer;background:var(--panel)}
  .tab.active{background:var(--primary);color:#fff;border-color:transparent}

  /* Cards */
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .muted{color:var(--muted)}

  /* Table */
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{border-bottom:1px solid var(--border);padding:10px;text-align:left;vertical-align:top}
  th{font-weight:600;color:#b9c4d6}
  tr:hover td{background:rgba(255,255,255,0.02)}

  /* Buttons & Inputs */
  input,textarea,select{width:100%;padding:10px;background:var(--ink);border:1px solid var(--border);border-radius:8px;color:var(--text)}
  button{background:var(--primary);color:#fff;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn-ghost{background:transparent;border:1px dashed var(--border)}
  .btn-danger{background:var(--bad)}

  /* Status tags */
  .tag{display:inline-block;padding:2px 8px;border-radius:6px;border:1px solid var(--border);font-size:.85rem}
  .tag.NEW{background:#2b2b16;color:#efe3a1}
  .tag.APPROVED{background:#12331f;color:#8fe9b8}
  .tag.REJECTED{background:#3a1720;color:#ff9fb1}

  /* Modal */
  .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);backdrop-filter:blur(2px);padding:16px;z-index:50}
  .modal.show{display:flex}
  .modal .box{width:min(720px,100%);background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
  .box h3{margin:0 0 8px 0}
</style>
</head>
<body>
<div class="wrap">
  <div class="tabs">
    <div class="tab active" id="tabMine">C·ªßa t√¥i</div>
    <div class="tab" id="tabApprove">C·∫ßn duy·ªát</div>
    <div style="flex:1"></div>
    <button id="btnOpenCreate" class="btn-ghost">‚ûï T·∫°o ƒë·ªÅ xu·∫•t</button>
  </div>

  <!-- MINE DASHBOARD -->
  <div class="card" id="minePane">
    <div class="row" style="justify-content:space-between">
      <h2>üìÑ ƒê·ªÅ xu·∫•t c·ªßa t√¥i</h2>
      <div class="row">
        <input id="mineEmpId" placeholder="employee_id ƒë·ªÉ l·ªçc" style="width:200px">
        <button id="btnLoadMine">L√†m m·ªõi</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Ng√†y t·∫°o</th>
          <th>#</th>
          <th>Ti√™u ƒë·ªÅ</th>
          <th>Lo·∫°i</th>
          <th>Tr·∫°ng th√°i</th>
          <th>Ghi ch√∫</th>
        </tr>
      </thead>
      <tbody id="tblMine"></tbody>
    </table>
  </div>

  <!-- APPROVAL DASHBOARD -->
  <div class="card" id="approvePane" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h2>üßæ C·∫ßn duy·ªát</h2>
      <div class="row">
        <input id="apprMgrId" placeholder="manager_id ƒë·ªÉ l·ªçc" style="width:220px">
        <button id="btnLoadAppr">L√†m m·ªõi</button>
      </div>
    </div>
    <table>
      <thead>
        <tr>
          <th>Ng√†y t·∫°o</th>
          <th>#</th>
          <th>Nh√¢n vi√™n</th>
          <th>Ti√™u ƒë·ªÅ</th>
          <th>Lo·∫°i</th>
          <th>Tr·∫°ng th√°i</th>
          <th>Thao t√°c</th>
        </tr>
      </thead>
      <tbody id="tblAppr"></tbody>
    </table>
  </div>
</div>

<!-- CREATE MODAL -->
<div class="modal" id="createModal">
  <div class="box">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3>‚ûï T·∫°o ƒë·ªÅ xu·∫•t</h3>
      <button id="btnCloseCreate" class="btn-ghost">ƒê√≥ng</button>
    </div>
    <div class="row">
      <div style="flex:1">
        <label>Employee ID</label>
        <input id="empId">
      </div>
      <div style="flex:1">
        <label>Manager ID</label>
        <input id="mgrId">
      </div>
    </div>
    <div class="row">
      <div style="flex:1">
        <label>Lo·∫°i</label>
        <select id="type">
          <option value="0">Resign</option>
          <option value="1">Salary Increase</option>
          <option value="2">Contribution</option>
        </select>
      </div>
      <div style="flex:2">
        <label>Ti√™u ƒë·ªÅ</label>
        <input id="title">
      </div>
    </div>
    <label>N·ªôi dung</label>
    <textarea id="content" rows="4"></textarea>
    <div class="row" style="justify-content:flex-end">
      <button id="btnSend">G·ª≠i</button>
    </div>
    <div id="msgCreate" class="muted" style="margin-top:8px"></div>
  </div>
</div>

<script>
  const API = '/the20/proposals/';
  const $ = s=>document.querySelector(s);
  let cacheAll = [];

  const TYPE_TXT = {0:'Resign',1:'Salary Increase',2:'Contribution'};
  const ST_TXT = {0:'NEW',1:'APPROVED',2:'REJECTED'};

  const fmt = s=>{ if(!s) return ''; try{ const d=new Date(s); return d.toLocaleString(); }catch{ return s; } };
  const createdKey = r => (r.created_at || '');

  function switchTab(which){
    const mine = which==='mine';
    $('#tabMine').classList.toggle('active', mine);
    $('#tabApprove').classList.toggle('active', !mine);
    $('#minePane').style.display = mine ? '' : 'none';
    $('#approvePane').style.display = mine ? 'none' : '';
  }
  $('#tabMine').onclick = ()=> switchTab('mine');
  $('#tabApprove').onclick = ()=> switchTab('appr');

  async function loadAll(){
    try{
      const res = await fetch(API);
      const data = await res.json();
      cacheAll = Array.isArray(data) ? data : (data.results || []);
    }catch(e){ cacheAll = []; }
  }

  function pillType(t){ return TYPE_TXT[t] || t; }
  function tagStatus(s){ return `<span class="tag ${ST_TXT[s]||''}">${ST_TXT[s]||s}</span>`; }

  function renderMine(){
    const empId = parseInt($('#mineEmpId').value||'',10);
    const rows = Number.isInteger(empId) ? cacheAll.filter(x=> x.employee_id===empId) : [];
    // sort newest created first
    rows.sort((a,b)=> createdKey(b).localeCompare(createdKey(a)));
    const tb = $('#tblMine'); tb.innerHTML='';
    for(const r of rows){
      tb.insertAdjacentHTML('beforeend', `
        <tr>
          <td>${fmt(r.created_at)}</td>
          <td>${r.id}</td>
          <td>${(r.title||'')}</td>
          <td>${pillType(r.type)}</td>
          <td>${tagStatus(r.status)}</td>
          <td>${r.decision_note||''}</td>
        </tr>`);
    }
  }

  function renderApprove(){
    const mgrId = parseInt($('#apprMgrId').value||'',10);
    const rows = Number.isInteger(mgrId) ? cacheAll.filter(x=> x.manager_id===mgrId) : [];
    // sort: NEW first, then newest created
    rows.sort((a,b)=>{
      const aw = (a.status===0?0:1), bw=(b.status===0?0:1);
      if(aw!==bw) return aw-bw;
      return createdKey(b).localeCompare(createdKey(a));
    });

    const tb = $('#tblAppr'); tb.innerHTML='';
    for(const r of rows){
      const id = r.id;
      const actBtns = `
        <div class="row">
          <button onclick="decide(${id},true)">Duy·ªát</button>
          <button class="btn-danger" onclick="decide(${id},false)">T·ª´ ch·ªëi</button>
        </div>
        <input id="note_${id}" placeholder="Ghi ch√∫ quy·∫øt ƒë·ªãnh (optional)" style="margin-top:6px;width:220px">`;

      tb.insertAdjacentHTML('beforeend', `
        <tr data-id="${id}">
          <td>${fmt(r.created_at)}</td>
          <td>${id}</td>
          <td>${r.employee_id}</td>
          <td>${(r.title||'')}</td>
          <td>${pillType(r.type)}</td>
          <td id="st_${id}">${tagStatus(r.status)}</td>
          <td>${actBtns}</td>
        </tr>`);
    }
  }

  async function decide(id, approve){
    const note = document.getElementById('note_'+id)?.value || '';
    const res = await fetch(`${API}${id}/${approve?'approve':'reject'}/`, {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({note})
    });
    if(res.ok){
      await loadAll();
      renderApprove();
      renderMine();
    } else {
      alert('‚ùå L·ªói thao t√°c');
    }
  }

  function openCreate(){ $('#createModal').classList.add('show'); }
  function closeCreate(){ $('#createModal').classList.remove('show'); $('#msgCreate').textContent=''; }
  $('#btnOpenCreate').onclick = openCreate;
  $('#btnCloseCreate').onclick = closeCreate;

  $('#btnSend').onclick = async ()=>{
    const payload = {
      employee_id: parseInt($('#empId').value||'',10),
      manager_id:  $('#mgrId').value ? parseInt($('#mgrId').value,10) : null,
      type:        parseInt($('#type').value,10),
      title:       $('#title').value,
      content:     $('#content').value || ''
    };
    const res = await fetch(API, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload)});
    $('#msgCreate').textContent = res.ok? '‚úÖ G·ª≠i th√†nh c√¥ng' : '‚ùå L·ªói g·ª≠i';
    if(res.ok){ await loadAll(); renderMine(); renderApprove(); closeCreate(); }
  };

  $('#btnLoadMine').onclick  = async ()=>{ await loadAll(); renderMine(); };
  $('#btnLoadAppr').onclick  = async ()=>{ await loadAll(); renderApprove(); };

  loadAll();
</script>
</body>
</html>
