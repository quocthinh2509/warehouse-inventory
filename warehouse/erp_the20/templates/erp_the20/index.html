<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Ch·∫•m c√¥ng The20</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      max-width: 520px;
    }
    h1 { color: #2c3e50; }
    label { font-weight: bold; display: block; margin-top: 12px; }
    input, select, button {
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
      margin-top: 6px;
    }
    button {
      margin-top: 12px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover { background: #2980b9; }
    #log {
      margin-top: 20px;
      white-space: pre-line;
      padding: 10px;
      background: #f6f6f6;
      border: 1px solid #ddd;
      border-radius: 4px;
      max-height: 480px;
      overflow-y: auto;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <h1>Ch·∫•m c√¥ng The20</h1>

  <label>
    M√£ nh√¢n vi√™n (employee ID):
    <input id="empId" type="number" placeholder="VD: 1" />
  </label>

  <label>
    ID ca l√†m (shift_instance - t√πy ch·ªçn):
    <input id="shiftId" type="number" placeholder="VD: 12 (c√≥ th·ªÉ b·ªè tr·ªëng)" />
  </label>

  <button onclick="sendAttendance('checkin')">Check-in</button>
  <button onclick="sendAttendance('checkout')">Check-out</button>

  <div id="log"></div>
  <script>
    const FLASK_SERVER   = "https://192.168.1.43:3000"; // Flask token server
    const DJANGO_BACKEND = "https://barcode.the20.vn";  // Django backend
  
    // Danh s√°ch token c√≤n h·∫°n
    let activeTokens = [];
  
    async function sendAttendance(action) {
      const empId   = document.getElementById("empId").value.trim();
      const shiftId = document.getElementById("shiftId").value.trim();
  
      if (!empId) {
        log("‚ùå Vui l√≤ng nh·∫≠p M√£ nh√¢n vi√™n (s·ªë ID)");
        return;
      }
  
      try {
        // 1Ô∏è‚É£ L·∫•y token t·ª´ Flask
        const tokenRes = await fetch(`${FLASK_SERVER}/request-token`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ empId: empId })
        });
  
        if (!tokenRes.ok) {
          const errText = await tokenRes.text();
          throw new Error(`L·ªói xin token (${tokenRes.status}): ${errText}`);
        }
  
        const { token, issuedAt, expiresAt, expiresIn, fromLocalIp } = await tokenRes.json();

        log(`‚úÖ Token m·ªõi: ${token}`);
        log(`   ‚Ä¢ issuedAt: ${issuedAt || "?"}`);
        log(`   ‚Ä¢ expiresAt: ${expiresAt || "?"}`);
        log(`   ‚Ä¢ expiresIn: ${expiresIn || "?"}s`);
        log(`   ‚Ä¢ fromLocalIp: ${fromLocalIp || "?"}\n`);
        
        // Th√™m v√†o danh s√°ch token c√≤n h·∫°n
        activeTokens.push({ token, issuedAt, expiresAt, expiresIn, fromLocalIp });
        renderTokens();
  
        // 2Ô∏è‚É£ G·ª≠i d·ªØ li·ªáu t·ªõi Django
        const payload = {
          employee: parseInt(empId, 10),
          source: "web"
        };
        if (shiftId) payload.shift_instance = parseInt(shiftId, 10);
  
        const attendanceRes = await fetch(
          `${DJANGO_BACKEND}/the20/attendance/${action}/`,
          {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "X-Local-Access": token
            },
            body: JSON.stringify(payload)
          }
        );
  
        const result = await attendanceRes.json().catch(() => ({}));
  
        if (!attendanceRes.ok) {
          throw new Error(`L·ªói ${action.toUpperCase()} (${attendanceRes.status}): ${JSON.stringify(result)}`);
        }
  
        log(`üéâ ${action.toUpperCase()} th√†nh c√¥ng:\n${JSON.stringify(result, null, 2)}\n`);
  
      } catch (err) {
        log(`‚ö†Ô∏è L·ªói ${action.toUpperCase()}: ${err.message}\n`);
      }
    }
  
    // Hi·ªÉn th·ªã log
    function log(msg) {
      const logDiv = document.getElementById("log");
      logDiv.textContent += msg + "\n";
      logDiv.scrollTop = logDiv.scrollHeight;
    }
  
    // Render danh s√°ch token c√≤n h·∫°n
    function renderTokens() {
      const logDiv = document.getElementById("log");
      logDiv.textContent += "\nüìå Danh s√°ch token c√≤n h·∫°n:\n";
      activeTokens.forEach((t, i) => {
        logDiv.textContent += `${i + 1}. ${t.token}\n   ‚Ä¢ expiresAt: ${t.expiresAt || "Kh√¥ng r√µ"}\n   ‚Ä¢ expiresIn: ${t.expiresIn || "?"}s\n   ‚Ä¢ fromLocalIp: ${t.fromLocalIp || "?"}\n`;
      });
      logDiv.textContent += "--------------------------\n";
    }
  </script>
  
</body>
</html>
