<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ERP The20 • Đăng ký ca (hàng=ca, cột=thứ)</title>
  <style>
    :root{
      --bg:#0f1115; --panel:#151922; --muted:#7a8599; --text:#e6eefc; --primary:#4f8cff;
      --ok:#2ecc71; --bad:#ff5c5c; --border:#2a3140; --chip:#1e2633;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";}
    .wrap{max-width:1200px;margin:24px auto;padding:0 16px}
    .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:16px}
    h1{margin:0 0 .6rem 0;font-size:1.5rem}
    h2{margin:.2rem 0 .8rem 0;color:var(--muted);font-size:1rem}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .right{justify-content:flex-end}
    .muted{color:var(--muted)}
    .note{font-size:.9rem;color:#aeb8cd}
    .input,select,button{background:#0f131a;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px 12px}
    button{cursor:pointer}
    button.primary{background:var(--primary);color:#fff}
    button.ok{background:var(--ok);border-color:#22b962}
    button.bad{background:var(--bad)}
    button.ghost{background:transparent}
    button:disabled{opacity:.6;cursor:not-allowed}
    .mb8{margin-bottom:8px}.mb12{margin-bottom:12px}.mb16{margin-bottom:16px}.mb24{margin-bottom:24px}

    /* REGISTER GRID (transposed) */
    .table-wrap{overflow:auto}
    table{width:100%;border-collapse:collapse;min-width:760px}
    th,td{border-bottom:1px dashed var(--border);padding:8px 10px;text-align:left;vertical-align:middle}
    th{color:#a6b2c8;font-weight:600}
    tr:hover{background:#141a29}
    .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
    .code{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0b0f15;border:1px solid var(--border);padding:1px 6px;border-radius:6px}
    .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--border);font-size:.8rem}
    .pill.ok{background:#15301f;color:#9ef3c5;border-color:#1e5f3b}
    .pill.pending{background:#2b2b16;color:#efe3a1;border-color:#6a5f2a}
    .pill.bad{background:#3a1720;color:#ff9fb1;border-color:#6e2536}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">

    <!-- ============ REGISTER ============ -->
    <div class="card mb24">
      <div class="flex mb12" style="justify-content:space-between">
        <h1>Đăng ký ca tuần tới</h1>
        <div class="flex right">
          <label class="muted">Employee ID</label>
          <input id="empId" class="input" placeholder="e.g. 204" style="width:120px"/>
          <label class="muted">Nguồn</label>
          <select id="defaultSource"><option value="0">0</option><option value="1">1</option></select>
          <label class="muted">Work mode</label>
          <select id="defaultWorkMode"><option value="0">0</option><option value="1">1</option></select>
          <label class="muted">Bonus</label>
          <input id="defaultBonus" class="input" value="0.00" style="width:120px"/>
        </div>
      </div>

      <div class="flex mb12">
        <div class="code" id="weekLabel">Tuần: …</div>
        <button class="ghost" id="prevWeek">← Tuần trước</button>
        <button class="ghost" id="nextWeek">Tuần sau →</button>
        <span class="note">Bảng bên dưới: <b>Hàng = Ca</b>, <b>Cột = Thứ 2…CN</b>. Tick ô để đăng ký.</span>
      </div>

      <div class="table-wrap">
        <table id="registerTable">
          <thead>
            <tr id="regHead">
              <!-- th: Ca | Thứ 2 | ... | CN -->
            </tr>
          </thead>
          <tbody id="regBody">
            <!-- rows = shift templates -->
          </tbody>
        </table>
      </div>

      <div class="flex mb8" style="justify-content:space-between">
        <div id="empMsg" class="note"></div>
        <div class="flex right">
          <button id="clearSelection" class="ghost">Bỏ chọn</button>
          <button id="registerBtn" class="primary">Đăng ký theo lô</button>
        </div>
      </div>
    </div>

    <!-- ============ DASHBOARD (employee only) ============ -->
    <div class="card">
      <div class="flex mb12" style="justify-content:space-between">
        <h2>Dashboard đăng ký (của nhân viên này)</h2>
        <div class="flex right">
          <label class="muted">Từ ngày</label><input id="dashFrom" type="date" class="input"/>
          <label class="muted">Đến ngày</label><input id="dashTo" type="date" class="input"/>
          <button id="refreshDash" class="ghost">Làm mới</button>
        </div>
      </div>
      <div class="table-wrap">
        <table id="dashTable">
          <thead>
            <tr>
              <th>Ngày</th>
              <th>Giờ</th>
              <th>Template</th>
              <th>Status</th>
              <th>Source</th>
              <th>Work mode</th>
              <th>Bonus</th>
              <th>Requested By</th>
              <th>Approved By</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </div>

  <script>
    // ========================= CONFIG =========================
    const API_BASE = "/the20";
    const ENDPOINTS = {
      shiftTemplates: `${API_BASE}/shifts/templates/`,
      batchRegister: `${API_BASE}/attendance/batch-register/`,   // all-or-nothing 201/400
      search:        `${API_BASE}/attendance/search`,            // filter by employee_id + date range
      cancel:        (id)=> `${API_BASE}/attendance/${id}/cancel/`, // PUT {employee_id}
    };

    // ========================= Utils =========================
    const $ = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const dayName = i=>['Thứ 2','Thứ 3','Thứ 4','Thứ 5','Thứ 6','Thứ 7','Chủ nhật'][i];
    const ymd = d=>d.toISOString().slice(0,10);
    const addDays = (d,n)=>{const x=new Date(d); x.setDate(x.getDate()+n); return x;};
    const fmtTime = t=>!t?"":t.slice(0,5);
    function startOfNextWeekMonday(base=new Date()){
      const day = base.getDay() || 7; // 1..7 (Mon..Sun)
      const mon = addDays(new Date(base.getFullYear(), base.getMonth(), base.getDate()), 8-day);
      mon.setHours(0,0,0,0);
      return mon;
    }
    function pillStatus(st){
      if(st==='APPROVED') return `<span class="pill ok">${st}</span>`;
      if(st==='PENDING')  return `<span class="pill pending">${st}</span>`;
      return `<span class="pill bad">${st||''}</span>`;
    }
    function showMsg(el,msg,ok=false){ el.textContent=msg; el.className= ok?'note':'note muted'; }

    // ========================= State =========================
    let weekMonday = startOfNextWeekMonday();
    let shiftTemplates = []; // [{id, code, name, start_time, end_time, ...}]

    // ========================= Load templates =========================
    async function loadShiftTemplates(){
      const res = await fetch(ENDPOINTS.shiftTemplates);
      if(!res.ok) throw new Error('Không tải được Shift Templates');
      const data = await res.json();
      shiftTemplates = Array.isArray(data) ? data : (data.results||[]);
      shiftTemplates.sort((a,b)=>(a.start_time||'').localeCompare(b.start_time||''));
    }

    // ========================= Build REGISTER grid =========================
    function renderRegisterGrid(){
      const head = $('#regHead'); head.innerHTML = '';
      const body = $('#regBody'); body.innerHTML = '';

      const weekDates = Array.from({length:7}, (_,i)=> addDays(weekMonday, i));
      $('#weekLabel').textContent = `Tuần: ${ymd(weekDates[0])} → ${ymd(weekDates[6])}`;

      // header: [Ca] + seven day cols
      const th0 = document.createElement('th'); th0.textContent = 'Ca làm';
      head.appendChild(th0);
      weekDates.forEach((d,i)=>{
        const th = document.createElement('th');
        th.innerHTML = `<div><strong>${dayName(i)}</strong> <span class="muted mono">${ymd(d)}</span></div>`;
        head.appendChild(th);
      });

      // body rows = templates
      for(const t of shiftTemplates){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>
            <div class="flex">
              <span class="mono">${fmtTime(t.start_time)}–${fmtTime(t.end_time)}</span>
              <span class="code">${t.code||''}</span>
              <span class="muted">${t.name||''}</span>
            </div>
          </td>
        `;
        weekDates.forEach(d=>{
          const td = document.createElement('td');
          td.innerHTML = `<input type="checkbox" class="pick" data-template="${t.id}" data-date="${ymd(d)}" />`;
          tr.appendChild(td);
        });
        body.appendChild(tr);
      }
    }

    function collectBatchItems(){
      const items = [];
      $$('.pick:checked').forEach(chk=>{
        items.push({ date: chk.dataset.date, shift_template: parseInt(chk.dataset.template,10) });
      });
      return items;
    }

    async function doBatchRegister(){
      const empId = parseInt($('#empId').value||'',10);
      if(!empId){ showMsg($('#empMsg'),'Nhập Employee ID trước khi đăng ký'); return; }
      const items = collectBatchItems();
      if(items.length===0){ showMsg($('#empMsg'),'Chưa tick ca nào'); return; }

      const payload = {
        employee_id: empId,
        default_source: parseInt($('#defaultSource').value,10)||0,
        default_work_mode: parseInt($('#defaultWorkMode').value,10)||0,
        default_bonus: $('#defaultBonus').value||'0.00',
        items
      };

      $('#registerBtn').disabled = true;
      showMsg($('#empMsg'),'Đang gửi…', true);
      try{
        const res = await fetch(ENDPOINTS.batchRegister, {
          method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)
        });
        const data = await res.json();
        if(res.status===201){
          showMsg($('#empMsg'),`Tạo thành công ${data.created?.length||0} bản ghi`, true);
          $$('.pick:checked').forEach(c=>c.checked=false);
          await loadDashboard(); // refresh
        }else{
          const errs = (data.errors||[]).map(e=>`[#${e.index}] ${e.error}`).join('\n');
          showMsg($('#empMsg'),`Không tạo bản ghi nào:\n${errs}`);
        }
      }catch(e){
        showMsg($('#empMsg'),'Lỗi kết nối');
      }finally{
        $('#registerBtn').disabled = false;
      }
    }

    // ========================= Dashboard (employee only) =========================
    async function loadDashboard(){
      const empId = ($('#empId').value||'').trim();
      if(!empId){
        $('#dashTable tbody').innerHTML = `<tr><td colspan="10" class="muted">Nhập Employee ID để xem dashboard.</td></tr>`;
        return;
      }
      const params = new URLSearchParams();
      params.set('employee_id', empId);  // lọc theo nhân viên
      if($('#dashFrom').value) params.set('date_from', $('#dashFrom').value);
      if($('#dashTo').value) params.set('date_to', $('#dashTo').value);
      params.set('include_deleted','false');

      const res = await fetch(`${ENDPOINTS.search}?${params.toString()}`);
      if(!res.ok){ $('#dashTable tbody').innerHTML = `<tr><td colspan="10" class="muted">Không tải được dữ liệu.</td></tr>`; return; }
      const data = await res.json();
      const rows = Array.isArray(data) ? data : (data.results||[]);

      // sort theo template.start_time (rồi theo ngày)
      rows.sort((a,b)=>{
        const sa = a.template_start_time || a.shift_template?.start_time || '';
        const sb = b.template_start_time || b.shift_template?.start_time || '';
        if(sa!==sb) return sa.localeCompare(sb);
        const da = a.date||'', db=b.date||'';
        return da.localeCompare(db);
      });

      const tb = $('#dashTable tbody'); tb.innerHTML='';
      for(const r of rows){
        const s = r.template_start_time || r.shift_template?.start_time || '';
        const e = r.template_end_time || r.shift_template?.end_time || '';
        const code = r.template_code || r.shift_template?.code || '';
        const name = r.template_name || r.shift_template?.name || '';
        const status = r.status || r.status_display || '';
        const canCancel = status === 'PENDING'; // chỉ cho cancel khi chưa duyệt

        tb.insertAdjacentHTML('beforeend', `
          <tr data-id="${r.id}">
            <td>${r.date||''}</td>
            <td class="mono">${fmtTime(s)}–${fmtTime(e)}</td>
            <td>${code} <span class="muted">${name}</span></td>
            <td>${pillStatus(status)}</td>
            <td>${r.source??''}</td>
            <td>${r.work_mode??''}</td>
            <td>${r.bonus??''}</td>
            <td>${r.requested_by??''}</td>
            <td>${r.approved_by??''}</td>
            <td class="row-actions">
              ${canCancel ? `<button class="bad btn-cancel" data-id="${r.id}">Cancel</button>` : ``}
            </td>
          </tr>
        `);
      }

      // bind cancel buttons
      $$('.btn-cancel').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.dataset.id;
          if(!confirm('Huỷ đăng ký ca này?')) return;
          const emp = parseInt($('#empId').value,10);
          const res = await fetch(ENDPOINTS.cancel(id), {
            method:'PUT', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({ employee_id: emp })
          });
          const data = await res.json().catch(()=>({}));
          if(!res.ok){ alert(data.detail || 'Huỷ thất bại'); return; }
          await loadDashboard();
        });
      });
    }

    // ========================= Events / Boot =========================
    $('#prevWeek').addEventListener('click', ()=>{ weekMonday = addDays(weekMonday, -7); renderRegisterGrid(); });
    $('#nextWeek').addEventListener('click', ()=>{ weekMonday = addDays(weekMonday, 7);  renderRegisterGrid(); });
    $('#registerBtn').addEventListener('click', doBatchRegister);
    $('#clearSelection').addEventListener('click', ()=> $$('.pick:checked').forEach(c=> c.checked=false));
    $('#refreshDash').addEventListener('click', loadDashboard);
    $('#empId').addEventListener('change', loadDashboard);

    (async function boot(){
      // mặc định range dashboard: hôm nay -3 → +10
      const today = new Date();
      $('#dashFrom').value = ymd(addDays(today, -3));
      $('#dashTo').value   = ymd(addDays(today, 10));

      await loadShiftTemplates();
      renderRegisterGrid();
      loadDashboard();
    })();
  </script>
</body>
</html>
