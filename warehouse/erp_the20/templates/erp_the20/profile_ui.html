<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ERP The20 ‚Ä¢ H·ªì s∆° nh√¢n vi√™n</title>
<style>
  :root{
    --bg:#0f1115;--panel:#151922;--ink:#0f131a;--border:#2a3140;--text:#e6eefc;--muted:#8a93a6;--primary:#4f8cff;--ok:#22c55e;
  }
  *{box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:system-ui;margin:0}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px}
  h1{margin:0 0 12px 0;font-size:1.3rem}
  .grid{display:grid;gap:10px;grid-template-columns:repeat(2,1fr)}
  label{display:block;margin-top:2px;color:var(--muted);font-size:.9rem}
  input,textarea,select{width:100%;padding:8px 10px;background:#0f131a;border:1px solid var(--border);border-radius:8px;color:var(--text)}
  textarea{resize:vertical}
  .row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
  button{padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--primary);color:#fff;cursor:pointer}
  .btn{background:var(--primary)}
  .btn.dark{background:#2c3e50}
  .btn.ok{background:var(--ok)}
  .muted{color:var(--muted)}
  .tabs{display:flex;gap:8px;margin-bottom:12px}
  .tab{padding:8px 12px;border:1px solid var(--border);border-radius:999px;cursor:pointer;background:#0f131a}
  .tab.active{background:var(--primary);color:#fff;border-color:transparent}
  .hidden{display:none}
  table{width:100%;border-collapse:collapse;border:1px solid var(--border)}
  th,td{padding:8px 10px;border-bottom:1px solid var(--border);text-align:left;vertical-align:top;font-size:.95rem}
  thead th{position:sticky;top:0;background:#101520;z-index:1}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
  .toolbar input{max-width:280px}
  .pager{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:10px}
  .pill{display:inline-block;padding:4px 8px;border-radius:999px;background:#0f131a;border:1px solid var(--border);font-size:.85rem}
</style>
</head>
<body>
<div class="wrap">

  <!-- Tabs -->
  <div class="tabs">
    <div class="tab active" data-tab="profile">üë§ H·ªì s∆° c√° nh√¢n</div>
    <div class="tab" data-tab="dashboard">üìä Dashboard qu·∫£n l√Ω</div>
  </div>

  <!-- PROFILE CARD -->
  <div id="tab_profile" class="card">
    <h1>üë§ H·ªì s∆° nh√¢n vi√™n</h1>
    <div class="row">
      <div style="flex:1">
        <label>user_id</label>
        <input id="user_id" placeholder="VD: 117">
      </div>
      <div class="row" style="flex:1;justify-content:flex-end;gap:8px">
        <button id="btnLoad" class="btn dark">Load</button>
        <button id="btnSave" class="btn">üíæ L∆∞u</button>
      </div>
    </div>

    <div class="grid" style="margin-top:10px">
      <div><label>H·ªç t√™n</label><input id="full_name"></div>
      <div><label>Email</label><input id="email"></div>

      <div><label>CCCD</label><input id="cccd"></div>
      <div><label>Ng√†y sinh</label><input id="date_of_birth" type="date"></div>

      <div><label>ƒê·ªãa ch·ªâ th∆∞·ªùng tr√∫</label><input id="address"></div>
      <div><label>ƒê·ªãa ch·ªâ t·∫°m tr√∫</label><input id="temporary_address"></div>

      <div><label>Ng√†y v√†o c√¥ng ty</label><input id="first_day_in_job" type="date"></div>
      <div><label>M·ª©c l∆∞∆°ng hi·ªán t·∫°i</label><input id="salary" type="number" step="0.01"></div>

      <div><label>S·ªë ƒëi·ªán tho·∫°i</label><input id="phone"></div>
      <div><label>Li√™n h·ªá kh·∫©n c·∫•p (T√™n)</label><input id="emergency_contact"></div>

      <div><label>ƒêi·ªán tho·∫°i kh·∫©n c·∫•p</label><input id="emergency_phone"></div>
      <div><label>B·∫±ng c·∫•p</label><input id="degree"></div>

      <div><label>C√¥ng ty c≈©</label><input id="old_company"></div>
      <div><label>M√£ s·ªë thu·∫ø</label><input id="tax_code"></div>

      <div><label>BHXH</label><input id="bhxh"></div>
      <div><label>Xe g·ª≠i t·∫°i c√¥ng ty (lo·∫°i/s·ªë/nƒÉm SX)</label><input id="car"></div>

      <div><label>Link h·ªì s∆° (CV/Hƒê)</label><input id="doc_link"></div>
      <div><label>Link ·∫£nh</label><input id="picture_link"></div>

      <div style="grid-column:1/-1">
        <label>N·ªôi dung Offer</label><textarea id="offer_content" rows="3"></textarea>
      </div>
      <div style="grid-column:1/-1">
        <label>Ghi ch√∫</label><textarea id="note" rows="3"></textarea>
      </div>
    </div>

    <div id="msg" class="muted" style="margin-top:10px"></div>
  </div>

  <!-- DASHBOARD CARD -->
  <div id="tab_dashboard" class="card hidden">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h1 style="margin:0">üìä Dashboard qu·∫£n l√Ω ‚Äì Danh s√°ch nh√¢n vi√™n</h1>
      <span id="sum" class="pill">T·ªïng: 0</span>
    </div>

    <div class="toolbar">
      <input id="q" placeholder="T√¨m theo T√™n/Email/Phone/CCCD...">
      <select id="page_size">
        <option value="20">20 / trang</option>
        <option value="50" selected>50 / trang</option>
        <option value="100">100 / trang</option>
        <option value="200">200 / trang</option>
      </select>
      <button id="btnSearch" class="btn dark">T√¨m</button>
      <button id="btnExport" class="btn ok">‚Ü• Xu·∫•t CSV</button>
    </div>

    <div style="overflow:auto;max-height:60vh;border:1px solid var(--border);border-radius:10px">
      <table id="tbl">
        <thead>
          <tr>
            <th style="width:80px">User ID</th>
            <th>H·ªç t√™n</th>
            <th>Email</th>
            <th>Phone</th>
            <th>CCCD</th>
            <th>Ng√†y v√†o</th>
            <th>L∆∞∆°ng</th>
            <th>H√†nh ƒë·ªông</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="pager">
      <button id="prev" class="btn dark">‚óÄ Tr∆∞·ªõc</button>
      <span id="page_info" class="pill">Trang 1</span>
      <button id="next" class="btn dark">Sau ‚ñ∂</button>
    </div>

    <div id="msg_dash" class="muted" style="margin-top:10px"></div>
  </div>

</div>

<script>
const API_BASE = '/the20/profile/';
const $ = s=>document.querySelector(s);
const F = [
  'full_name','email','cccd','date_of_birth','address','temporary_address','first_day_in_job',
  'salary','phone','emergency_contact','emergency_phone','degree','old_company','tax_code',
  'bhxh','car','doc_link','picture_link','offer_content','note'
];

function collect() {
  const data={}; F.forEach(k=>{ data[k] = $('#'+k).value || null; });
  if(data.salary!==null && data.salary!=='') data.salary = parseFloat(data.salary);
  return data;
}
function fill(d) {
  F.forEach(k=>{
    const v = d && d[k]!=null ? d[k] : '';
    $('#'+k).value = (k.includes('date') && v && (''+v).length>10) ? (''+v).slice(0,10) : v;
  });
  if(d && d.user_id!=null){ $('#user_id').value = d.user_id; }
}
async function loadProfile(){
  const id = $('#user_id').value.trim(); if(!id){$('#msg').textContent='‚ö†Ô∏è Nh·∫≠p user_id';return;}
  $('#msg').textContent='ƒêang t·∫£i...';
  const res = await fetch(`${API_BASE}${id}/`);
  if(!res.ok){ $('#msg').textContent='‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c h·ªì s∆°'; return; }
  const data = await res.json();
  fill(data); $('#msg').textContent='‚úÖ ƒê√£ t·∫£i h·ªì s∆°';
}
async function saveProfile(){
  const id = $('#user_id').value.trim(); if(!id){$('#msg').textContent='‚ö†Ô∏è Nh·∫≠p user_id';return;}
  $('#msg').textContent='ƒêang l∆∞u...';
  const payload = collect();
  const res = await fetch(`${API_BASE}${id}/`, { method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(payload) });
  $('#msg').textContent = res.ok ? '‚úÖ L∆∞u th√†nh c√¥ng' : '‚ùå L·ªói khi l∆∞u';
}

/* ===== Dashboard (Manager) ===== */
let state = { page: 1, page_size: 50, q: '' };

function fmtDate(s){ if(!s) return ''; const t = (''+s).slice(0,10); return t; }
function fmtMoney(n){ if(n==null || n==='') return ''; const x = Number(n); return isNaN(x)? '': x.toLocaleString(); }

async function reloadTable(){
  $('#msg_dash').textContent='ƒêang t·∫£i danh s√°ch...';
  const url = new URL(location.origin + API_BASE);
  url.searchParams.set('page', state.page);
  url.searchParams.set('page_size', state.page_size);
  if(state.q) url.searchParams.set('q', state.q);

  const res = await fetch(url.toString());
  if(!res.ok){ $('#msg_dash').textContent='‚ùå Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch'; return; }
  const { total, page, page_size, results } = await res.json();
  $('#sum').textContent = 'T·ªïng: ' + total;
  $('#page_info').textContent = `Trang ${page}`;
  const tb = $('#tbl tbody');
  tb.innerHTML = '';

  for(const r of results){
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.user_id ?? ''}</td>
      <td>${r.full_name ?? ''}</td>
      <td>${r.email ?? ''}</td>
      <td>${r.phone ?? ''}</td>
      <td>${r.cccd ?? ''}</td>
      <td>${fmtDate(r.first_day_in_job)}</td>
      <td>${fmtMoney(r.salary)}</td>
      <td>
        <button class="btn dark btnEdit" data-id="${r.user_id}">Ch·ªânh</button>
      </td>
    `;
    tb.appendChild(tr);
  }

  // g·∫Øn handler Edit
  document.querySelectorAll('.btnEdit').forEach(btn=>{
    btn.onclick = async (e)=>{
      const id = e.currentTarget.getAttribute('data-id');
      if(!id) return;
      const res = await fetch(`${API_BASE}${id}/`);
      if(!res.ok) return;
      const data = await res.json();
      fill(data);
      // chuy·ªÉn sang tab Profile ƒë·ªÉ ch·ªânh
      switchTab('profile');
      $('#msg').textContent = '‚û°Ô∏è ƒê√£ n·∫°p h·ªì s∆° t·ª´ Dashboard';
    }
  });

  $('#msg_dash').textContent = `‚úÖ ƒê√£ t·∫£i ${results.length} b·∫£n ghi`;
}

function switchTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('[id^="tab_"]').forEach(x=>x.classList.add('hidden'));
  document.querySelector(`.tab[data-tab="${name}"]`).classList.add('active');
  document.querySelector(`#tab_${name}`).classList.remove('hidden');
}

/* export CSV t·ª´ d·ªØ li·ªáu hi·ªán tr√™n trang */
function toCSV(rows){
  const header = ['user_id','full_name','email','phone','cccd','first_day_in_job','salary'];
  const csv = [header.join(',')];
  rows.forEach(r=>{
    const line = [
      r.user_id ?? '', (r.full_name??'').replaceAll(',',' '),
      r.email ?? '', r.phone ?? '', r.cccd ?? '',
      fmtDate(r.first_day_in_job), r.salary ?? ''
    ].join(',');
    csv.push(line);
  });
  return csv.join('\n');
}
async function exportCSV(){
  const url = new URL(location.origin + API_BASE);
  url.searchParams.set('page', state.page);
  url.searchParams.set('page_size', state.page_size);
  if(state.q) url.searchParams.set('q', state.q);
  const res = await fetch(url.toString());
  if(!res.ok) return;
  const data = await res.json();
  const blob = new Blob([toCSV(data.results)], {type: 'text/csv;charset=utf-8;'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `employee_profiles_p${data.page}.csv`;
  a.click();
}

/* wiring */
$('#btnLoad').onclick = loadProfile;
$('#btnSave').onclick = saveProfile;

document.querySelectorAll('.tab').forEach(tab=>{
  tab.onclick = ()=>switchTab(tab.getAttribute('data-tab'));
});

$('#btnSearch').onclick = ()=>{
  state.q = $('#q').value.trim();
  state.page = 1;
  state.page_size = parseInt($('#page_size').value || '50', 10);
  reloadTable();
};
$('#prev').onclick = ()=>{ state.page = Math.max(1, state.page - 1); reloadTable(); };
$('#next').onclick = ()=>{ state.page = state.page + 1; reloadTable(); };
$('#page_size').onchange = ()=>{ state.page = 1; state.page_size = parseInt($('#page_size').value||'50',10); reloadTable(); };
$('#btnExport').onclick = exportCSV;

/* m·∫∑c ƒë·ªãnh: m·ªü tab Profile; n·∫øu manager mu·ªën xem, b·∫•m Dashboard v√† t√¨m */
</script>
</body>
</html>
