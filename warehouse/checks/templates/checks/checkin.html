{% extends "base_simple.html" %}
{% block title %}Check IN/OUT{% endblock %}
{% block content %}

<div class="card">
  <h2>Check IN / OUT</h2>
  <p class="muted small">Trang n√†y d√πng ƒë·ªÉ test ch·ª©c nƒÉng ch·∫•m c√¥ng qua API <span class="mono">POST /erp/api/attend/check</span>.</p>
  <div class="row" style="margin-top:10px">
    <div>
      <label>Ch·ªçn nh√¢n vi√™n</label>
      <select id="employeeSelect"></select>
    </div>
    <div>
      <label>Lo·∫°i</label>
      <select id="typeSelect">
        <option value="IN">IN</option>
        <option value="OUT">OUT</option>
      </select>
    </div>
    <div>
      <label>Ghi ch√∫</label>
      <input id="noteInput" placeholder="v√≠ d·ª•: ƒëi l√†m / v·ªÅ s·ªõm..." />
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>Lat</label>
      <input id="lat" readonly class="mono" />
    </div>
    <div>
      <label>Lng</label>
      <input id="lng" readonly class="mono" />
    </div>
    <div>
      <label>Accuracy (m)</label>
      <input id="acc" readonly class="mono" />
    </div>
  </div>

  <div class="grid2" style="margin-top:12px">
    <div class="small muted" id="gpsStatus">GPS: ch∆∞a l·∫•y</div>
    <div class="right">
      <button class="warn" id="btnGPS">L·∫•y t·ªça ƒë·ªô</button>
      <button class="primary" id="btnCheckIn">G·ª≠i IN</button>
      <button class="primary" id="btnCheckOut">G·ª≠i OUT</button>
    </div>
  </div>
</div>

<div class="card">
  <div class="grid2">
    <h3>K·∫øt qu·∫£</h3>
    <button id="btnQuickHistory" class="ok small">Xem 20 b·∫£n ghi g·∫ßn nh·∫•t</button>
  </div>
  <pre id="result" class="mono" style="white-space:pre-wrap; background:#0b1226; padding:12px; border-radius:10px; overflow:auto; max-height:260px;"></pre>
</div>

{% endblock %}

{% block scripts %}
<script>
(async function initPage() {
  // load employees
  const empSel = document.getElementById('employeeSelect');
  try {
    const emps = await jsonFetch(API.EMPS);
    empSel.innerHTML = emps.map(e => `<option value="${e.id}">${e.userID} ‚Äî ${e.full_name}</option>`).join('');
  } catch (e) {
    empSel.innerHTML = `<option disabled>L·ªói t·∫£i employees</option>`;
    console.error(e);
  }

  // GPS
  const lat = document.getElementById('lat');
  const lng = document.getElementById('lng');
  const acc = document.getElementById('acc');
  const gpsStatus = document.getElementById('gpsStatus');

  let lastPos = null;
  async function getGPS() {
    gpsStatus.textContent = "GPS: ƒëang l·∫•y‚Ä¶";
    return new Promise((resolve, reject) => {
      if (!navigator.geolocation) {
        gpsStatus.textContent = "Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ geolocation.";
        return reject(new Error("no-geolocation"));
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const { latitude, longitude, accuracy } = pos.coords;
          lat.value = latitude.toFixed(6);
          lng.value = longitude.toFixed(6);
          acc.value = accuracy ? accuracy.toFixed(0) : "";
          lastPos = { lat: latitude, lng: longitude, acc: accuracy };
          gpsStatus.textContent = `GPS: OK (${accuracy ? accuracy.toFixed(0) : "?"} m)`;
          resolve(lastPos);
        },
        (err) => {
          gpsStatus.textContent = `GPS l·ªói: ${err.message}`;
          reject(err);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
      );
    });
  }

  document.getElementById('btnGPS').addEventListener('click', getGPS);

  async function submitCheck(type) {
    const employee_id = parseInt(empSel.value, 10);
    const note = document.getElementById('noteInput').value || "";
    const pos = lastPos || await getGPS();

    const payload = {
      employee_id,
      type,
      lat: pos.lat,
      lng: pos.lng,
      accuracy: pos.acc || null,
      note,
      source: "web"
    };

    try {
      const data = await jsonFetch(API.CHECK, {
        method: "POST",
        body: JSON.stringify(payload),
      });
      document.getElementById('result').textContent =
        "‚úÖ G·ª≠i th√†nh c√¥ng:\n" + JSON.stringify(data, null, 2);
    } catch (e) {
      document.getElementById('result').textContent =
        "‚ùå L·ªói (" + e.status + "):\n" + JSON.stringify(e.data, null, 2);
      console.error(e);
    }
  }

  document.getElementById('btnCheckIn').addEventListener('click', () => submitCheck("IN"));
  document.getElementById('btnCheckOut').addEventListener('click', () => submitCheck("OUT"));

  // quick history
  document.getElementById('btnQuickHistory').addEventListener('click', async () => {
    try {
      const list = await jsonFetch(API.LIST + "?_=" + Date.now());
      document.getElementById('result').textContent =
        "üìÑ 20 b·∫£n ghi g·∫ßn nh·∫•t:\n" + JSON.stringify(list.slice(0,20), null, 2);
    } catch (e) {
      document.getElementById('result').textContent =
        "‚ùå L·ªói (" + e.status + "):\n" + JSON.stringify(e.data, null, 2);
    }
  });
})();
</script>
{% endblock %}
