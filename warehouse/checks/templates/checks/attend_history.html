{% extends "base_simple.html" %}
{% block title %}Lịch sử chấm công{% endblock %}
{% block content %}

<div class="card">
  <h2>Lịch sử chấm công</h2>
  <div class="row" style="margin-top:10px">
    <div>
      <label>Từ ngày</label>
      <input type="date" id="dateFrom">
    </div>
    <div>
      <label>Đến ngày</label>
      <input type="date" id="dateTo">
    </div>
    <div>
      <label>Nhân viên</label>
      <select id="employeeFilter">
        <option value="">-- Tất cả --</option>
      </select>
    </div>
    <div>
      <label>Công trường</label>
      <select id="worksiteFilter">
        <option value="">-- Tất cả --</option>
      </select>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <div>
      <label>Trạng thái</label>
      <select id="statusFilter">
        <option value="">-- Tất cả --</option>
        <option>accepted</option>
        <option>out_of_geofence</option>
        <option>low_accuracy</option>
        <option>duplicate</option>
        <option>blocked</option>
        <option>manual</option>
      </select>
    </div>
    <div>
      <label>Loại</label>
      <select id="typeFilter">
        <option value="">-- Tất cả --</option>
        <option>IN</option>
        <option>OUT</option>
      </select>
    </div>
    <div>
      <label class="muted">&nbsp;</label>
      <button id="btnSearch" class="primary">Tìm</button>
    </div>
    <div>
      <label class="muted">&nbsp;</label>
      <button id="btnExport" class="ok">Tải CSV</button>
    </div>
  </div>
</div>

<div class="card">
  <div class="grid2">
    <h3>Kết quả</h3>
    <div class="right small muted" id="countLabel"></div>
  </div>
  <div style="overflow:auto">
    <table id="tbl">
      <thead>
        <tr>
          <th>#</th>
          <th>Ngày</th>
          <th>Giờ</th>
          <th>NV</th>
          <th>Phòng ban</th>
          <th>Loại</th>
          <th>Trạng thái</th>
          <th>Worksite</th>
          <th>Khoảng cách(m)</th>
          <th>Acc(m)</th>
          <th>Ghi chú</th>
          <th>Source</th>
          <th>IP</th>
        </tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>
</div>

{% endblock %}
{% block scripts %}
<script>
(async function initHistory() {
  // prefill ngày = hôm nay
  const today = new Date(); const yyyy = today.getFullYear();
  const mm = String(today.getMonth()+1).padStart(2,'0');
  const dd = String(today.getDate()).padStart(2,'0');
  document.getElementById('dateFrom').value = `${yyyy}-${mm}-${dd}`;
  document.getElementById('dateTo').value   = `${yyyy}-${mm}-${dd}`;

  // load filters
  try {
    const [emps, wss] = await Promise.all([jsonFetch(API.EMPS), jsonFetch(API.WSS)]);
    document.getElementById('employeeFilter').insertAdjacentHTML('beforeend',
      emps.map(e => `<option value="${e.id}">${e.userID} — ${e.full_name}</option>`).join('')
    );
    document.getElementById('worksiteFilter').insertAdjacentHTML('beforeend',
      wss.map(w => `<option value="${w.id}">${w.code} — ${w.name}</option>`).join('')
    );
  } catch (e) { console.error(e); }

  function buildQuery() {
    const p = new URLSearchParams();
    const df = document.getElementById('dateFrom').value;
    const dt = document.getElementById('dateTo').value;
    const ei = document.getElementById('employeeFilter').value;
    const wi = document.getElementById('worksiteFilter').value;
    const st = document.getElementById('statusFilter').value;
    const ty = document.getElementById('typeFilter').value;
    if (df) p.set('date_from', df);
    if (dt) p.set('date_to', dt);
    if (ei) p.set('employee_id', ei);
    if (wi) p.set('worksite_id', wi);
    if (st) p.set('status', st);
    if (ty) p.set('type', ty);
    return p.toString();
  }

  async function search() {
    const qs = buildQuery();
    try {
      const data = await jsonFetch(API.LIST + (qs ? `?${qs}` : ''));
      renderTable(data);
    } catch (e) {
      alert("Lỗi tải dữ liệu: " + (e.status || "") + "\n" + JSON.stringify(e.data));
    }
  }

  function renderTable(rows) {
    const tbody = document.getElementById('tbody');
    document.getElementById('countLabel').textContent = rows.length + " bản ghi";
    tbody.innerHTML = rows.map((r, i) => {
      const pillCls = r.status === 'accepted' ? 'ok' : (r.status === 'duplicate' ? 'warn' : 'err');
      return `<tr>
        <td>${i+1}</td>
        <td class="mono">${r.local_date}</td>
        <td class="mono">${new Date(r.ts).toLocaleTimeString()}</td>
        <td>${r.employee?.userID || ''} — ${r.employee?.full_name || ''}</td>
        <td>${r.employee?.department_name || ''}</td>
        <td>${r.type}</td>
        <td><span class="pill ${pillCls}">${r.status}</span></td>
        <td>${r.worksite?.code || ''} — ${r.worksite?.name || ''}</td>
        <td class="right mono">${r.distance_m ?? ''}</td>
        <td class="right mono">${r.accuracy ?? ''}</td>
        <td class="small">${r.note || ''}</td>
        <td class="small">${r.source}</td>
        <td class="mono small">${r.ip || ''}</td>
      </tr>`;
    }).join('');
  }

  document.getElementById('btnSearch').addEventListener('click', search);
  document.getElementById('btnExport').addEventListener('click', () => {
    const qs = buildQuery();
    const url = API.EXPORT + (qs ? `?${qs}` : '');
    window.open(url, "_blank"); // tải file CSV
  });

  // auto search lần đầu
  search();
})();
</script>
{% endblock %}
