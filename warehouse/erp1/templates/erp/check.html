<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Chấm công (Check IN/OUT)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --card:#fff; --border:#e5e7eb; --muted:#6b7280; }
    body { font-family: system-ui, Arial; margin: 0; background:#f8fafc; color:#111827; }
    .wrap { max-width: 1080px; margin: 24px auto; padding: 0 16px; }
    h1 { font-size: 20px; margin: 0 0 12px; }
    .grid { display:grid; gap:16px; grid-template-columns: 1.2fr .8fr; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:14px; padding:16px; }
    label { display:block; font-size:13px; color:var(--muted); margin:10px 0 6px; }
    select, input[type=text], input[type=number], input[type=date], input[type=month] {
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:14px;
    }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .btns { display:flex; gap:8px; margin-top:12px; }
    button { border:0; border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:600; }
    .primary { background:#2563eb; color:#fff; }
    .ghost { background:#eef2ff; color:#1e3a8a; }
    .warn { background:#fee2e2; color:#991b1b; }
    pre { background:#0b1220; color:#d1e7ff; padding:12px; border-radius:10px; overflow:auto; font-size:12px; }
    table { width:100%; border-collapse: collapse; margin-top: 12px; }
    th, td { border-bottom:1px solid var(--border); padding:8px; text-align:left; font-size:13px; }
    small { color:var(--muted); }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Chấm công IN/OUT</h1>
    <div class="grid">
      <div class="card">
        <div class="row">
          <div>
            <label>Nhân viên</label>
            <select id="employee"></select>
          </div>
          <div>
            <label>Địa điểm (Worksite)</label>
            <select id="worksite">
              <option value="">-- Không chọn --</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div>
            <label>Device ID (tuỳ chọn)</label>
            <input id="device_id" placeholder="vd: chrome-uuid" />
          </div>
          <div>
            <label>Ghi chú</label>
            <input id="note" placeholder="ghi chú..." />
          </div>
        </div>

        <div class="row">
          <div>
            <label><input id="use_gps" type="checkbox" checked /> Dùng vị trí (HTML5 Geolocation)</label>
            <small>* Desktop thường có độ chính xác thấp (&gt; 100-300m)</small>
          </div>
          <div>
            <label>Độ chính xác gửi lên (nếu có)</label>
            <input id="accuracy_override" type="number" placeholder="vd: 50 (m) - để trống nếu dùng GPS" />
          </div>
        </div>

        <div class="btns">
          <button class="primary" onclick="doCheck('IN')">Check IN</button>
          <button class="ghost" onclick="doCheck('OUT')">Check OUT</button>
          <button class="warn" onclick="loadToday()">Tải log hôm nay</button>
        </div>

        {% comment %} <div style="margin-top:10px">
          <small>Chống trùng: nếu bấm liên tiếp cùng loại trong {{DUP_WINDOW_MIN||3}} phút sẽ bị 409.</small>
        </div> {% endcomment %}
      </div>

      <div class="card">
        <h3>Kết quả</h3>
        <pre id="result">...</pre>
      </div>
    </div>

    <div class="card" style="margin-top:16px">
      <h3>Nhật ký hôm nay</h3>
      <table>
        <thead>
          <tr>
            <th>Thời điểm</th><th>Loại</th><th>Worksite</th><th>Acc(m)</th><th>Dist(m)</th><th>Hợp lệ</th><th>Ghi chú</th>
          </tr>
        </thead>
        <tbody id="logs"></tbody>
      </table>
    </div>
  </div>

<script>
const unwrap = (d) => d?.results ?? d;
function getCsrfToken(){
  const name="csrftoken="; const c=document.cookie.split(";").find(s=>s.trim().startsWith(name));
  return c? decodeURIComponent(c.trim().substring(name.length)) : "";
}
async function apiGet(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error("GET "+url+" -> "+r.status);
  return await r.json();
}
async function apiPost(url, body){
  const r = await fetch(url, {
    method:"POST",
    headers:{ "Content-Type":"application/json", "X-CSRFToken": getCsrfToken() },
    body: JSON.stringify(body||{})
  });
  const json = await r.json().catch(()=> ({}));
  return { ok:r.ok, status:r.status, json };
}

async function loadRefData(){
  const [emps, sites] = await Promise.all([
    apiGet("/erp/api/employees/"), apiGet("/erp/api/worksites/")
  ]);
  const $emp = document.getElementById("employee");
  $emp.innerHTML = unwrap(emps).map(e=>`<option value="${e.id}">${e.code} - ${e.full_name}</option>`).join("");
  const $site = document.getElementById("worksite");
  unwrap(sites).forEach(s=>{
    $site.insertAdjacentHTML("beforeend", `<option value="${s.id}">${s.code} - ${s.name}</option>`);
  });
}

function todayStr(){ const d=new Date(); return d.toISOString().slice(0,10); }

async function loadToday(){
  const emp = document.getElementById("employee").value;
  if(!emp){ alert("Chọn nhân viên trước"); return; }
  const url = `/erp/api/attend/logs/?employee_id=${emp}&date_from=${todayStr()}&date_to=${todayStr()}`;
  const data = await apiGet(url);
  const rows = unwrap(data);
  const $tb = document.getElementById("logs");
  $tb.innerHTML = rows.map(r=>`
    <tr>
      <td>${r.occurred_at}</td>
      <td>${r.type}</td>
      <td>${r.worksite?.name??""}</td>
      <td>${r.accuracy_m??""}</td>
      <td>${r.distance_m??""}</td>
      <td>${r.is_valid?"✔":"✖"}</td>
      <td>${r.note??""}</td>
    </tr>
  `).join("");
}

function withGpsThenSend(send){
  if(!document.getElementById("use_gps").checked){
    const acc = document.getElementById("accuracy_override").value;
    send(null, acc? Number(acc): null);
    return;
  }
  const opts = { enableHighAccuracy:true, timeout:8000 };
  navigator.geolocation.getCurrentPosition(
    pos => send(pos, null),
    _err => send(null, null),
    opts
  );
}

async function doCheck(type){
  const employee_id = Number(document.getElementById("employee").value||0);
  if(!employee_id){ alert("Chọn nhân viên"); return; }
  const worksite_id = Number(document.getElementById("worksite").value||0) || undefined;
  const device_id = document.getElementById("device_id").value || "";
  const note = document.getElementById("note").value || "";
  const setResult = (o)=> document.getElementById("result").textContent = JSON.stringify(o,null,2);

  withGpsThenSend(async (pos, accOverride)=>{
    const body = { employee_id, type, device_id, note };
    if(worksite_id) body.worksite_id = worksite_id;
    if(pos && pos.coords){
      body.lat = pos.coords.latitude;
      body.lng = pos.coords.longitude;
      body.accuracy_m = Math.round(pos.coords.accuracy || 0);
    }
    if(accOverride!=null){ body.accuracy_m = accOverride; }

    const res = await apiPost("/erp/api/attend/check", body);
    setResult({status:res.status, ok:res.ok, ...res.json});
    if(res.ok) loadToday();
  });
}

loadRefData().then(loadToday).catch(console.error);
</script>
</body>
</html>
